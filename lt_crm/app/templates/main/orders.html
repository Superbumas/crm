{% extends "base.html" %}

{% block title %}U≈æsakymai - LT CRM{% endblock %}

{% block styles %}
<style>
    [x-cloak] { display: none !important; }
    
    /* Enhanced visual hierarchy */
    .page-header {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    /* Improved table styling */
    .orders-table {
        background: white;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .orders-table thead th {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        font-weight: 600;
        color: #374151;
        padding: 1rem 0.75rem;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .orders-table tbody tr {
        transition: all 0.15s ease;
    }
    
    .orders-table tbody tr:hover {
        background-color: #f8fafc;
        transform: scale(1.005);
    }
    
    .orders-table tbody td {
        padding: 0.875rem 0.75rem;
        vertical-align: middle;
    }
    
    /* Enhanced action buttons */
    .action-btn {
        transition: all 0.15s ease;
        border-radius: 0.5rem;
    }
    
    .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Improved search and filter section */
    .filter-section {
        background: white;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    /* Enhanced pagination */
    .pagination-wrapper {
        background: white;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        padding: 1rem;
    }
    
    /* Better responsive design */
    @media (max-width: 768px) {
        .orders-table {
            font-size: 0.875rem;
        }
        
        .orders-table thead th,
        .orders-table tbody td {
            padding: 0.5rem 0.375rem;
        }
        
        .action-btn {
            padding: 0.25rem;
        }
    }
    
    /* Accessibility improvements */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
    
    /* Focus indicators */
    .focus-visible:focus {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
    }
    
    /* Toast styling */
    #toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 9999;
    }
    
    #toast-container .alert {
        margin-bottom: 0.5rem;
        transition: opacity 0.3s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header with improved visual hierarchy -->
<div class="page-header p-6 mb-6">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">U≈æsakym≈≥ valdymas</h1>
            <nav class="text-sm breadcrumbs" aria-label="Breadcrumb">
                <ul>
                    <li><a href="{{ url_for('main.dashboard') }}" class="text-blue-600 hover:text-blue-800">Skydelis</a></li>
                    <li><span class="text-gray-500">U≈æsakymai</span></li>
                </ul>
            </nav>
        </div>
        
        <div class="flex flex-wrap gap-3">
            <a href="{{ url_for('main.order_new') }}" class="btn btn-primary action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Naujas u≈æsakymas
            </a>
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-outline btn-primary action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19l3 3m0 0l3-3m-3 3V10" />
                    </svg>
                    Eksportuoti
                </label>
                <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a href="#">CSV formatu</a></li>
                    <li><a href="#">Excel formatu</a></li>
                    <li><a href="#">PDF ataskaita</a></li>
                </ul>
            </div>
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-outline action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                    </svg>
                    Veiksmai
                </label>
                <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                    <li><a href="{{ url_for('main.reports') }}">Ataskaitos</a></li>
                    <li><a href="#">Masinis redagavimas</a></li>
                    <li><a href="#">Archyvuoti senus</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Search & Filter Section -->
<div class="filter-section p-6 mb-6">
    <div class="flex items-center gap-3 mb-6">
        <div class="p-2 bg-blue-50 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900">Paie≈°ka ir filtrai</h3>
    </div>
        
        <form method="GET" action="{{ url_for('main.orders') }}" class="space-y-4">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                <!-- Search Input -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Paie≈°ka</span>
                    </label>
                    <div class="input-group">
                        <input type="text" name="q" value="{{ request.args.get('q', '') }}" 
                               placeholder="U≈æsakymo nr., klientas, el. pa≈°tas..." 
                               class="input input-bordered w-full focus:border-primary" />
                        <button type="submit" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Status Filter -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">B≈´sena</span>
                    </label>
                    <select name="status" class="select select-bordered w-full focus:border-primary">
                        <option value="">üîç Visos b≈´senos</option>
                        <option value="new" {% if request.args.get('status') == 'new' %}selected{% endif %}>üÜï Naujas</option>
                        <option value="paid" {% if request.args.get('status') == 'paid' %}selected{% endif %}>‚úÖ Apmokƒótas</option>
                        <option value="packed" {% if request.args.get('status') == 'packed' %}selected{% endif %}>üì¶ Supakuotas</option>
                        <option value="shipped" {% if request.args.get('status') == 'shipped' %}selected{% endif %}>üöö I≈°si≈≥stas</option>
                        <option value="returned" {% if request.args.get('status') == 'returned' %}selected{% endif %}>‚Ü©Ô∏è GrƒÖ≈æintas</option>
                        <option value="cancelled" {% if request.args.get('status') == 'cancelled' %}selected{% endif %}>‚ùå At≈°auktas</option>
                    </select>
                </div>
                
                <!-- Source Filter -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">≈†altinis</span>
                    </label>
                    <select name="source" class="select select-bordered w-full focus:border-primary">
                        <option value="">üåê Visi ≈°altiniai</option>
                        <option value="web" {% if request.args.get('source') == 'web' %}selected{% endif %}>üõí Internetinƒó parduotuvƒó</option>
                        <option value="manual" {% if request.args.get('source') == 'manual' %}selected{% endif %}>‚úèÔ∏è Rankinis</option>
                        <option value="api" {% if request.args.get('source') == 'api' %}selected{% endif %}>üîå API</option>
                    </select>
                </div>
                
                <!-- Action Buttons -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">Veiksmai</span>
                    </label>
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary flex-1 shadow-md hover:shadow-lg transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                            </svg>
                            Filtruoti
                        </button>
                        <a href="{{ url_for('main.orders') }}" class="btn btn-outline hover:btn-error transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Active Filters Display -->
            {% if request.args.get('q') or request.args.get('status') or request.args.get('source') %}
            <div class="divider"></div>
            <div class="flex flex-wrap gap-2 items-center">
                <span class="text-sm font-medium opacity-70">Aktyv≈´s filtrai:</span>
                {% if request.args.get('q') %}
                <div class="badge badge-primary gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    "{{ request.args.get('q') }}"
                </div>
                {% endif %}
                {% if request.args.get('status') %}
                <div class="badge badge-secondary gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    {{ request.args.get('status') }}
                </div>
                {% endif %}
                {% if request.args.get('source') %}
                <div class="badge badge-accent gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                    </svg>
                    {{ request.args.get('source') }}
                </div>
                {% endif %}
            </div>
            {% endif %}
        </form>
</div>

<!-- Orders Table -->
<div class="orders-table">
    <div class="card-header bg-gradient-to-r from-base-200 to-base-100 p-6 border-b border-base-300/50">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-success/10 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v6a2 2 0 002 2h6a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold">U≈æsakym≈≥ sƒÖra≈°as</h3>
                    <p class="text-sm opacity-70">Valdykite visus u≈æsakymus vienoje vietoje</p>
                </div>
            </div>
            {% if orders %}
            <div class="stats shadow-sm">
                <div class="stat py-2 px-4">
                    <div class="stat-title text-xs">Rasta u≈æsakym≈≥</div>
                    <div class="stat-value text-lg">{{ orders|length }}</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card-body p-0">
        <div class="table-container overflow-x-auto">
            <table class="table w-full">
                <thead class="bg-base-200/50">
                    <tr>
                        <th class="font-semibold">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                                </svg>
                                U≈æsakymas
                            </div>
                        </th>
                        <th class="font-semibold">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0V6a2 2 0 012-2h4a2 2 0 012 2v1m-6 0h6m-6 0l-1 1v4a2 2 0 002 2h2a2 2 0 002-2V8l-1-1" />
                                </svg>
                                Data
                            </div>
                        </th>
                        <th class="font-semibold">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                Klientas
                            </div>
                        </th>
                        <th class="font-semibold">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                B≈´sena
                            </div>
                        </th>
                        <th class="font-semibold text-right">
                            <div class="flex items-center gap-2 justify-end">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                                </svg>
                                Suma
                            </div>
                        </th>
                        <th class="font-semibold">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                Pristatymas
                            </div>
                        </th>
                        <th class="font-semibold">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Dokumentai
                            </div>
                        </th>
                        <th class="font-semibold">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                </svg>
                                Veiksmai
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% if orders %}
                        {% for order in orders %}
                        <tr class="hover:bg-base-200/50 transition-colors duration-200 border-b border-base-300/30" data-order-id="{{ order.id }}">
                            <td class="py-4">
                                <div class="flex items-center gap-3">
                                    <!-- Source Badge -->
                                    {% if order.source == 'web' %}
                                    <div class="badge badge-info gap-1 shadow-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9" />
                                        </svg>
                                        WEB
                                    </div>
                                    {% elif order.source == 'api' %}
                                    <div class="badge badge-warning gap-1 shadow-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        API
                                    </div>
                                    {% elif order.source == 'manual' %}
                                    <div class="badge badge-success gap-1 shadow-sm">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                        </svg>
                                        RANK
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Order Number -->
                                    <div>
                                        <a href="{{ url_for('main.order_detail', id=order.id) }}" 
                                           class="font-semibold text-primary hover:text-primary-focus transition-colors duration-200 hover:underline">
                                            {{ order.order_number }}
                                        </a>
                                        <div class="text-xs opacity-60 mt-1">ID: {{ order.id }}</div>
                                    </div>
                                </div>
                            </td>
                            
                            <td class="py-4">
                                <div class="flex flex-col">
                                    <span class="font-medium">{{ order.created_at.strftime('%Y-%m-%d') }}</span>
                                    <span class="text-xs opacity-60">{{ order.created_at.strftime('%H:%M') }}</span>
                                </div>
                            </td>
                            
                            <td class="py-4">
                                <div class="flex items-center gap-2">
                                    <div class="avatar placeholder">
                                        <div class="bg-neutral-focus text-neutral-content rounded-full w-8 h-8 text-xs">
                                            {% if order.customer %}
                                                {{ order.customer.name[:1] }}
                                            {% else %}
                                                {{ (order.shipping_name or 'N')[:1] }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div>
                                        {% if order.customer %}
                                        <a href="{{ url_for('main.customer_detail', id=order.customer_id) }}" 
                                           class="font-medium hover:text-primary transition-colors duration-200 hover:underline">
                                            {{ order.customer.name }}
                                        </a>
                                        {% else %}
                                        <span class="font-medium">{{ order.shipping_name or 'Nenurodyta' }}</span>
                                        {% endif %}
                                        {% if order.shipping_email %}
                                        <div class="text-xs opacity-60">{{ order.shipping_email }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="py-4">
                                <div class="status-control" data-order-id="{{ order.id }}">
                                    <div class="flex items-center gap-2">
                                        <div class="order-status-display">
                                            {% if order.status.value == 'new' %}
                                            <div class="badge badge-primary gap-2 shadow-sm">
                                                <div class="w-2 h-2 bg-primary-content rounded-full animate-pulse"></div>
                                                üÜï Naujas
                                            </div>
                                            {% elif order.status.value == 'paid' %}
                                            <div class="badge badge-success gap-2 shadow-sm">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                                </svg>
                                                ‚úÖ Apmokƒótas
                                            </div>
                                            {% elif order.status.value == 'packed' %}
                                            <div class="badge badge-warning gap-2 shadow-sm">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                                </svg>
                                                üì¶ Supakuotas
                                            </div>
                                            {% elif order.status.value == 'shipped' %}
                                            <div class="badge badge-info gap-2 shadow-sm">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                                </svg>
                                                üöö I≈°si≈≥stas
                                            </div>
                                            {% elif order.status.value == 'returned' %}
                                            <div class="badge badge-secondary gap-2 shadow-sm">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                                                </svg>
                                                ‚Ü©Ô∏è GrƒÖ≈æintas
                                            </div>
                                            {% elif order.status.value == 'cancelled' %}
                                            <div class="badge badge-error gap-2 shadow-sm">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                                ‚ùå At≈°auktas
                                            </div>
                                            {% else %}
                                            <div class="badge badge-ghost gap-2 shadow-sm">{{ order.status.value }}</div>
                                            {% endif %}
                                        </div>
                                        
                                        <button class="btn btn-xs btn-ghost edit-status-btn opacity-50 hover:opacity-100 transition-opacity" title="Redaguoti b≈´senƒÖ">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                            </svg>
                                        </button>
                                        
                                        <div class="status-edit-controls" style="display:none">
                                            <select class="select select-bordered select-sm status-select">
                                                <option value="new" {% if order.status.value == 'new' %}selected{% endif %}>üÜï Naujas</option>
                                                <option value="paid" {% if order.status.value == 'paid' %}selected{% endif %}>‚úÖ Apmokƒótas</option>
                                                <option value="packed" {% if order.status.value == 'packed' %}selected{% endif %}>üì¶ Supakuotas</option>
                                                <option value="shipped" {% if order.status.value == 'shipped' %}selected{% endif %}>üöö I≈°si≈≥stas</option>
                                                <option value="returned" {% if order.status.value == 'returned' %}selected{% endif %}>‚Ü©Ô∏è GrƒÖ≈æintas</option>
                                                <option value="cancelled" {% if order.status.value == 'cancelled' %}selected{% endif %}>‚ùå At≈°auktas</option>
                                            </select>
                                            <div class="flex gap-1 mt-1">
                                                <button class="btn btn-xs btn-success confirm-status-btn" title="I≈°saugoti">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                                    </svg>
                                                </button>
                                                <button class="btn btn-xs btn-error cancel-status-btn" title="At≈°aukti">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            
                            <td class="py-4 text-right">
                                <div class="flex flex-col items-end">
                                    <span class="font-bold text-lg">{{ order.total_amount|euro }}</span>
                                    {% if order.tax_amount %}
                                    <span class="text-xs opacity-60">+{{ order.tax_amount|euro }} PVM</span>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="py-4">
                                {% if order.shipping_country and order.shipping_city %}
                                <div class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    <div>
                                        <div class="font-medium">{{ order.shipping_city }}</div>
                                        <div class="text-xs opacity-60">{{ order.shipping_country }}</div>
                                    </div>
                                </div>
                                {% else %}
                                <span class="text-base-content/50">-</span>
                                {% endif %}
                            </td>
                            <td class="py-4">
                                <div class="space-y-2">
                                    {% if order_invoices and order.id in order_invoices %}
                                        {% for invoice in order_invoices[order.id] %}
                                        <div class="flex items-center gap-2">
                                            <div class="badge badge-sm gap-1 shadow-sm
                                                {% if invoice.status.value == 'draft' %}badge-ghost
                                                {% elif invoice.status.value == 'issued' %}badge-info
                                                {% elif invoice.status.value == 'paid' %}badge-success
                                                {% elif invoice.status.value == 'cancelled' %}badge-error
                                                {% endif %}">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                </svg>
                                                SF
                                            </div>
                                            <a href="{{ url_for('main.invoice_detail', id=invoice.id) }}" 
                                               class="text-sm font-medium link link-hover text-primary" 
                                               title="Sukurta: {{ invoice.created_at.strftime('%Y-%m-%d %H:%M') }}">
                                                {{ invoice.invoice_number }}
                                            </a>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="tooltip tooltip-left" data-tip="Sukurti sƒÖskaitƒÖ fakt≈´rƒÖ">
                                            <a href="{{ url_for('main.invoice_new_from_order', order_id=order.id) }}" 
                                               class="btn btn-sm btn-outline btn-primary gap-2 hover:shadow-md transition-all">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                                </svg>
                                                SF
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </td>
                            
                            <td class="py-4">
                                <div class="flex gap-1">
                                    <!-- View Order -->
                                    <div class="tooltip tooltip-left" data-tip="Per≈æi≈´rƒóti u≈æsakymƒÖ">
                                        <a href="{{ url_for('main.order_detail', id=order.id) }}" 
                                           class="btn btn-sm btn-ghost hover:btn-primary transition-all">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                            </svg>
                                        </a>
                                    </div>
                                    
                                    <!-- Edit Order -->
                                    <div class="tooltip tooltip-left" data-tip="Redaguoti u≈æsakymƒÖ">
                                        <a href="#" class="btn btn-sm btn-ghost hover:btn-warning transition-all edit-btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                        </a>
                                    </div>
                                    
                                    <!-- More Actions Dropdown -->
                                    <div class="dropdown dropdown-end">
                                        <label tabindex="0" class="btn btn-sm btn-ghost hover:btn-info transition-all">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                                            </svg>
                                        </label>
                                        <ul tabindex="0" class="dropdown-content menu p-2 shadow-xl bg-base-100 rounded-box w-48 border border-base-300">
                                            <li>
                                                <a href="{{ url_for('main.invoice_new_from_order', order_id=order.id) }}" class="gap-2">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                    </svg>
                                                    Sukurti sƒÖskaitƒÖ
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" class="gap-2">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                                                    </svg>
                                                    Spausdinti
                                                </a>
                                            </li>
                                            <li>
                                                <a href="#" class="gap-2">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                                    </svg>
                                                    Dubliuoti
                                                </a>
                                            </li>
                                            <div class="divider my-1"></div>
                                            <li>
                                                <button class="gap-2 text-error hover:bg-error/10 delete-order-btn" 
                                                        data-order-id="{{ order.id }}" 
                                                        data-order-number="{{ order.order_number }}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                    </svg>
                                                    I≈°trinti
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center py-16">
                                <div class="flex flex-col items-center gap-4">
                                    {% if request.args.get('q') or request.args.get('status') or request.args.get('source') %}
                                    <!-- No Results State -->
                                    <div class="p-4 bg-warning/10 rounded-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-warning" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                        </svg>
                                    </div>
                                    <div class="text-center">
                                        <h3 class="text-lg font-semibold mb-2">Nerasta u≈æsakym≈≥</h3>
                                        <p class="text-base-content/70 mb-4">Pagal pasirinktus filtrus u≈æsakym≈≥ nerasta. Pabandykite pakeisti paie≈°kos kriterijus.</p>
                                        <a href="{{ url_for('main.orders') }}" class="btn btn-primary gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                            </svg>
                                            I≈°valyti filtrus
                                        </a>
                                    </div>
                                    {% else %}
                                    <!-- Empty State -->
                                    <div class="p-4 bg-primary/10 rounded-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M8 11v6h8v-6M8 11h8" />
                                        </svg>
                                    </div>
                                    <div class="text-center">
                                        <h3 class="text-lg font-semibold mb-2">Dar nƒóra u≈æsakym≈≥</h3>
                                        <p class="text-base-content/70 mb-4">Pradƒókite nuo pirmojo u≈æsakymo suk≈´rimo ir stebƒókite savo verslo augimƒÖ.</p>
                                        <a href="{{ url_for('main.order_new') }}" class="btn btn-primary gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                            </svg>
                                            Sukurti pirmƒÖ u≈æsakymƒÖ
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination & Summary -->
{% if orders and orders|length > 0 %}
<div class="card bg-base-100 shadow-xl border border-base-300/50 mt-8">
    <div class="card-body">
        <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
            <!-- Results Summary -->
            <div class="flex items-center gap-3">
                <div class="p-2 bg-info/10 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-info" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </div>
                <div>
                    <p class="text-sm font-medium">Rodoma {{ orders|length }} u≈æsakym≈≥</p>
                    {% if pagination %}
                    <p class="text-xs opacity-60">{{ pagination.page }} puslapis i≈° {{ pagination.pages }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Pagination Controls -->
            {% if pagination and pagination.pages > 1 %}
            <div class="join">
                {% if pagination.has_prev %}
                <a href="{{ url_for('main.orders', page=pagination.prev_num, **request.args) }}" 
                   class="join-item btn btn-sm hover:btn-primary transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Ankstesnis
                </a>
                {% else %}
                <button class="join-item btn btn-sm btn-disabled">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Ankstesnis
                </button>
                {% endif %}
                
                {% for page in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page %}
                        {% if page == pagination.page %}
                        <button class="join-item btn btn-sm btn-primary">{{ page }}</button>
                        {% else %}
                        <a href="{{ url_for('main.orders', page=page, **request.args) }}" 
                           class="join-item btn btn-sm hover:btn-primary transition-all">{{ page }}</a>
                        {% endif %}
                    {% else %}
                        <button class="join-item btn btn-sm btn-disabled">...</button>
                    {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                <a href="{{ url_for('main.orders', page=pagination.next_num, **request.args) }}" 
                   class="join-item btn btn-sm hover:btn-primary transition-all">
                    Kitas
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </a>
                {% else %}
                <button class="join-item btn btn-sm btn-disabled">
                    Kitas
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Items per page -->
            <div class="flex items-center gap-2">
                <span class="text-sm opacity-70">Rodyti:</span>
                <select class="select select-sm select-bordered focus:border-primary" onchange="updatePerPage(this.value)">
                    <option value="10" {% if request.args.get('per_page') == '10' %}selected{% endif %}>10</option>
                    <option value="25" {% if request.args.get('per_page') == '25' or not request.args.get('per_page') %}selected{% endif %}>25</option>
                    <option value="50" {% if request.args.get('per_page') == '50' %}selected{% endif %}>50</option>
                    <option value="100" {% if request.args.get('per_page') == '100' %}selected{% endif %}>100</option>
                </select>
                <span class="text-sm opacity-70">per puslapƒØ</span>
            </div>
        </div>
    </div>
</div>

<script>
function updatePerPage(value) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', value);
    url.searchParams.delete('page'); // Reset to first page
    window.location.href = url.toString();
}
</script>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/htmx.org@1.9.2"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Restore saved statuses from session storage
        try {
            const savedOrders = JSON.parse(sessionStorage.getItem('orderStatuses') || '{}');
            console.log('Restored saved order statuses:', savedOrders);
            
            // Apply saved statuses to selects
            document.querySelectorAll('.status-control').forEach(control => {
                const orderId = control.getAttribute('data-order-id');
                if (orderId && savedOrders[orderId]) {
                    const select = control.querySelector('.status-select');
                    const savedStatus = savedOrders[orderId];
                    console.log(`Restoring status for order ${orderId}: ${savedStatus}`);
                    
                    // Update select and data attribute
                    select.value = savedStatus;
                    select.setAttribute('data-original-value', savedStatus);
                }
            });
        } catch (e) {
            console.error('Error restoring saved statuses:', e);
        }
        
        // Status change controls
        document.querySelectorAll('.status-select').forEach(select => {
            // Store the original value
            const originalValue = select.getAttribute('data-original-value');
            
            // Add change event listener
            select.addEventListener('change', function() {
                const statusControl = this.closest('.status-control');
                const statusActions = statusControl.querySelector('.status-actions');
                
                // Show the action buttons when status changes
                if (this.value !== originalValue) {
                    statusActions.style.display = '';
                } else {
                    statusActions.style.display = 'none';
                }
            });
        });
        
        // Cancel status change button
        document.querySelectorAll('.cancel-status-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const statusControl = this.closest('.status-control');
                const select = statusControl.querySelector('.status-select');
                const statusActions = statusControl.querySelector('.status-actions');
                
                // Revert to original value
                select.value = select.getAttribute('data-original-value');
                
                // Hide the action buttons
                statusActions.style.display = 'none';
            });
        });
        
        // Confirm status change button
        document.querySelectorAll('.confirm-status-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const statusControl = this.closest('.status-control');
                const select = statusControl.querySelector('.status-select');
                const statusActions = statusControl.querySelector('.status-actions');
                const orderId = statusControl.getAttribute('data-order-id');
                
                // Hide the action buttons
                statusActions.style.display = 'none';
                
                // Show loading indicator
                select.classList.add('select-disabled');
                select.disabled = true;
                
                // Save the new value via AJAX
                fetch(`/orders/${orderId}/update-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `status=${select.value}`
                })
                .then(response => {
                    console.log('Status update response status:', response.status);
                    // Check if the response is OK
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Status update response data:', data);
                    // Show success message
                    if (data.message) {
                        // Show toast message
                        let toast = document.createElement('div');
                        toast.className = 'toast toast-center toast-success';
                        toast.innerHTML = `<div class="alert alert-success"><span>${data.message}</span></div>`;
                        document.querySelector('.toast-container').appendChild(toast);
                        
                        // Remove the toast after 3 seconds
                        setTimeout(() => {
                            toast.remove();
                        }, 3000);
                    }
                    
                    // Set new original value from the response
                    if (data.new_status) {
                        console.log('Server returned new status:', data.new_status);
                        // Ensure select value matches server's value
                        select.value = data.new_status;
                        // Update the data attribute to match
                        console.log('Updating data-original-value to', data.new_status);
                        select.setAttribute('data-original-value', data.new_status);
                    } else {
                        // Fallback to using select.value
                        console.log('No new_status in response, using select.value:', select.value);
                        select.setAttribute('data-original-value', select.value);
                    }
                    
                    // Save status in session storage to prevent page refresh issues
                    try {
                        // Get or initialize orders storage
                        let savedOrders = JSON.parse(sessionStorage.getItem('orderStatuses') || '{}');
                        // Save this order's status
                        savedOrders[orderId] = select.value;
                        // Store back in session storage
                        sessionStorage.setItem('orderStatuses', JSON.stringify(savedOrders));
                        console.log('Saved order status in session storage:', orderId, select.value);
                    } catch (e) {
                        console.error('Error saving to session storage:', e);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Show error message
                    let toast = document.createElement('div');
                    toast.className = 'toast toast-center toast-error';
                    toast.innerHTML = `<div class="alert alert-error"><span>Klaida atnaujinant b≈´senƒÖ</span></div>`;
                    document.querySelector('.toast-container').appendChild(toast);
                    
                    // Remove the toast after 3 seconds
                    setTimeout(() => {
                        toast.remove();
                    }, 3000);
                    
                    // Revert to original value
                    select.value = select.getAttribute('data-original-value');
                })
                .finally(() => {
                    // Enable the select again
                    select.classList.remove('select-disabled');
                    select.disabled = false;
                });
            });
        });
        
        // Edit buttons - Link to order edit page
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const row = this.closest('tr');
                const orderId = row.getAttribute('data-order-id');
                window.location.href = `/orders/${orderId}/edit`;
            });
        });

        // Delete order handlers
        document.querySelectorAll('.delete-order-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                
                const orderId = this.getAttribute('data-order-id');
                const orderNumber = this.getAttribute('data-order-number');
                
                if (confirm(`Ar tikrai norite i≈°trinti u≈æsakymƒÖ ${orderNumber}? ≈†io veiksmo negalima bus at≈°aukti.`)) {
                    // Show loading state
                    this.innerHTML = '<span class="loading loading-spinner loading-xs"></span>';
                    this.disabled = true;
                    
                    // Delete order via API
                    fetch(`/orders/${orderId}/delete`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Remove the row from the table
                            this.closest('tr').remove();
                            showToast(data.message, 'success');
                        } else {
                            showToast(data.message, 'error');
                        }
                    })
                    .catch(error => {
                        showToast('Klaida trinant u≈æsakymƒÖ', 'error');
                        console.error('Error deleting order:', error);
                    })
                    .finally(() => {
                        // Reset button state
                        this.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>';
                        this.disabled = false;
                    });
                }
            });
        });
        
        // Helper function to show toast notifications
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `alert ${type === 'error' ? 'alert-error' : 'alert-success'} shadow-lg mb-4 animate__animated animate__fadeIn`;
            
            toast.innerHTML = `
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current flex-shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>${message}</span>
                </div>
                <button class="btn btn-sm btn-circle btn-ghost" onclick="this.parentElement.remove()">‚úï</button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('animate__fadeOut');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }

        // Edit status button functionality
        document.querySelectorAll('.edit-status-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const container = btn.closest('.status-control');
                container.querySelector('.order-status-text').style.display = 'none';
                btn.style.display = 'none';
                container.querySelector('.status-select').style.display = '';
                container.querySelector('.status-actions').style.display = '';
            });
        });

        // Cancel status button functionality
        document.querySelectorAll('.cancel-status-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const container = btn.closest('.status-control');
                container.querySelector('.order-status-text').style.display = '';
                container.querySelector('.edit-status-btn').style.display = '';
                container.querySelector('.status-select').style.display = 'none';
                container.querySelector('.status-actions').style.display = 'none';
            });
        });
    });
</script>
{% endblock %}
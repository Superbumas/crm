{% extends "base.html" %}

{% block title %}Produktai - LT CRM{% endblock %}

{% block styles %}
<style>
    [x-cloak] { display: none !important; }
    
    /* Toast styling */
    #toast-container {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 9999;
    }
    
    #toast-container .alert {
        margin-bottom: 0.5rem;
        transition: opacity 0.3s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col md:flex-row justify-between items-start mb-6">
    <div>
        <h1 class="text-2xl font-bold mb-2">Produktai</h1>
        <div class="text-sm breadcrumbs">
            <ul>
                <li><a href="{{ url_for('main.dashboard') }}">Skydelis</a></li>
                <li>Produktai</li>
            </ul>
        </div>
    </div>
    
    <div class="flex space-x-2 mt-4 md:mt-0">
        <a href="{{ url_for('main.product_new') }}" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Naujas produktas
        </a>
        <label for="export-modal" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19l3 3m0 0l3-3m-3 3V10" />
            </svg>
            Eksportuoti
        </label>
        <label for="import-modal" class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
            </svg>
            Importuoti produktus
        </label>
    </div>
</div>

<!-- Search & Filter -->
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <form method="GET" action="{{ url_for('main.products') }}">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="form-control">
                    <div class="input-group">
                        <input type="text" name="q" value="{{ request.args.get('q', '') }}" placeholder="Ieškoti pagal pavadinimą, SKU..." class="input input-bordered w-full" />
                        <button type="submit" class="btn btn-square">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="form-control">
                    <select name="category" class="select select-bordered w-full">
                        <option value="">Visos kategorijos</option>
                        {% for category in categories %}
                        <option value="{{ category }}" {% if request.args.get('category') == category %}selected{% endif %}>
                            {{ category }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-control">
                    <select name="stock" class="select select-bordered w-full">
                        <option value="">Visi likučiai</option>
                        <option value="in_stock" {% if request.args.get('stock') == 'in_stock' %}selected{% endif %}>Yra sandėlyje</option>
                        <option value="low" {% if request.args.get('stock') == 'low' %}selected{% endif %}>Mažas kiekis</option>
                        <option value="out_of_stock" {% if request.args.get('stock') == 'out_of_stock' %}selected{% endif %}>Nėra sandėlyje</option>
                    </select>
                </div>
                <div class="form-control flex flex-row space-x-2">
                    <button type="submit" class="btn btn-primary flex-1">Filtruoti</button>
                    <a href="{{ url_for('main.products') }}" class="btn btn-outline btn-error">Išvalyti</a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Products Table -->
<div class="card bg-base-100 shadow-xl overflow-hidden">
    <div class="card-body p-0">
        <div class="flex justify-end p-4">
            <div class="dropdown dropdown-end">
                <label tabindex="0" class="btn btn-sm btn-outline">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                    </svg>
                    Stulpeliai
                </label>
                <div tabindex="0" id="column-selector" class="dropdown-content z-[1] menu p-4 bg-base-100 shadow rounded-box w-64">
                    <h3 class="font-bold mb-2">Rodomi stulpeliai</h3>
                    <div class="form-control">
                        {% for col_id, col_info in product_columns.items() %}
                        <label class="label cursor-pointer justify-start">
                            <input type="checkbox" class="checkbox checkbox-sm checkbox-primary mr-2" 
                                   data-column-id="{{ col_id }}" 
                                   {% if col_id in selected_columns %}checked{% endif %}
                                   {% if col_id in ['sku', 'name'] %}disabled{% endif %} />
                            <span class="label-text">{{ col_info.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="mt-4">
                        <button id="save-columns" class="btn btn-primary btn-sm w-full">Išsaugoti</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Nuotrauka</th>
                        <th>Pavadinimas</th>
                        {% for col in selected_columns %}
                        {% if col not in ['sku', 'name'] %}
                        <th>{{ product_columns[col]['name'] }}</th>
                        {% endif %}
                        {% endfor %}
                        <th>Veiksmai</th>
                    </tr>
                </thead>
                <tbody>
                    {% if products %}
                        {% for product in products %}
                        <tr class="hover" data-product-id="{{ product.id }}">
                            <td>{{ product.sku }}</td>
                            <td>
                                {% if product.main_image_url %}
                                <div class="avatar">
                                    <div class="mask mask-squircle w-12 h-12">
                                        <img src="{{ product.main_image_url }}" alt="{{ product.name }}" />
                                    </div>
                                </div>
                                {% else %}
                                <div class="avatar placeholder">
                                    <div class="mask mask-squircle w-12 h-12 bg-neutral-focus text-neutral-content">
                                        <span>{{ product.name[:2] }}</span>
                                    </div>
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('main.product_detail', id=product.id) }}" class="font-medium hover:underline">
                                    {{ product.name }}
                                </a>
                                {% if product.barcode and 'barcode' not in selected_columns %}
                                <div class="text-xs opacity-60">EAN: {{ product.barcode }}</div>
                                {% endif %}
                            </td>
                            
                            {% for col in selected_columns %}
                            {% if col not in ['sku', 'name'] %}
                            <td>
                                {% if col == 'category' %}
                                    {{ product.category or '-' }}
                                {% elif col == 'barcode' %}
                                    {{ product.barcode or '-' }}
                                {% elif col == 'price_final' %}
                                    <div class="font-semibold">{{ product.price_final|euro }}</div>
                                {% elif col == 'price_old' %}
                                    <div class="text-xs line-through opacity-60">{{ product.price_old|euro if product.price_old else '-' }}</div>
                                {% elif col == 'quantity' %}
                                    <span class="badge {% if product.quantity > 10 %}badge-success{% elif product.quantity > 0 %}badge-warning{% else %}badge-error{% endif %}">
                                        {{ product.quantity }} vnt.
                                    </span>
                                {% elif col == 'manufacturer' %}
                                    {{ product.manufacturer or '-' }}
                                {% elif col == 'model' %}
                                    {{ product.model or '-' }}
                                {% elif col == 'delivery_days' %}
                                    {{ product.delivery_days or '-' }} d.
                                {% elif col == 'warranty_months' %}
                                    {{ product.warranty_months or '-' }} mėn.
                                {% elif col == 'weight_kg' %}
                                    {{ product.weight_kg or '-' }} kg
                                {% else %}
                                    {{ getattr(product, col, '-') }}
                                {% endif %}
                            </td>
                            {% endif %}
                            {% endfor %}
                            
                            <td>
                                <div class="flex space-x-1">
                                    <a href="{{ url_for('main.product_edit', id=product.id) }}" class="btn btn-square btn-sm btn-ghost">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                        </svg>
                                    </a>
                                    <button class="btn btn-square btn-sm btn-ghost" 
                                            hx-delete="{{ url_for('main.product_delete', id=product.id) }}"
                                            hx-confirm="Ar tikrai norite ištrinti šį produktą?"
                                            hx-target="closest tr"
                                            hx-swap="outerHTML swap:1s">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="{{ selected_columns|length + 3 }}" class="text-center py-8">
                                {% if request.args.get('q') or request.args.get('category') or request.args.get('stock') %}
                                    Nerasta produktų pagal pasirinktus filtrus.
                                    <a href="{{ url_for('main.products') }}" class="btn btn-sm btn-ghost mt-2">Išvalyti filtrus</a>
                                {% else %}
                                    Dar nėra produktų. <a href="{{ url_for('main.product_new') }}" class="link">Pridėkite naują produktą</a>.
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<div class="flex justify-center mt-6">
    <div class="btn-group">
        {% if pagination.has_prev %}
        <a href="{{ url_for('main.products', page=pagination.prev_num) }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        {% else %}
        <button class="btn btn-disabled">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        {% endif %}
        
        {% for page in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page %}
                {% if page == pagination.page %}
                <button class="btn btn-active">{{ page }}</button>
                {% else %}
                <a href="{{ url_for('main.products', page=page) }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn">{{ page }}</a>
                {% endif %}
            {% else %}
                <button class="btn btn-disabled">...</button>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <a href="{{ url_for('main.products', page=pagination.next_num) }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </a>
        {% else %}
        <button class="btn btn-disabled">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </button>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Import Modal -->
<input type="checkbox" id="import-modal" class="modal-toggle" />
<div class="modal">
    <div class="modal-box w-11/12 max-w-2xl">
        <h3 class="font-bold text-lg mb-4">Importuoti produktus</h3>
        <form id="csv-upload-form" method="POST" action="{{ url_for('main.product_import_file') }}" enctype="multipart/form-data" class="space-y-4">
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Importuojamas failas</span>
                </label>
                <input type="file" name="csv_file" accept=".csv,.xlsx,.xls,.tsv,.txt" class="file-input file-input-bordered w-full" required />
                <label class="label">
                    <span class="label-text-alt">Palaikomi formatai: CSV, Excel (.xlsx/.xls), TSV arba TXT</span>
                </label>
            </div>
            
            <div class="form-control">
                <div class="flex flex-col gap-2">
                    <div class="alert alert-info">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>Privalomi stulpeliai: <strong>sku</strong>, <strong>name</strong>, <strong>price_final</strong></span>
                    </div>
                </div>
            </div>
            
            <div class="divider">CSV/TSV/TXT nustatymai</div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Koduotė (character encoding)</span>
                </label>
                <select name="encoding" class="select select-bordered w-full">
                    <option value="">Automatinis aptikimas</option>
                    <option value="utf-8">UTF-8</option>
                    <option value="utf-8-sig">UTF-8 with BOM</option>
                    <option value="windows-1257">Windows-1257</option>
                    <option value="iso-8859-13">ISO-8859-13</option>
                    <option value="latin-1">Latin-1</option>
                </select>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Skyriklis (delimiter)</span>
                </label>
                <select name="delimiter" class="select select-bordered w-full">
                    <option value=",">Kablelis (,)</option>
                    <option value=";">Kabliataškis (;)</option>
                    <option value="\t">Tabuliacija (Tab)</option>
                    <option value="|">Vertikalus brūkšnys (|)</option>
                </select>
            </div>
            
            <div class="form-control">
                <label class="label cursor-pointer justify-start gap-4">
                    <input type="checkbox" name="has_header" class="checkbox" checked />
                    <span class="label-text">Pirma eilutė yra antraštė</span>
                </label>
            </div>
            
            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Importuoti</button>
                <label for="import-modal" class="btn" id="cancel-import">Atšaukti</label>
            </div>
        </form>
    </div>
</div>

<!-- Export Modal -->
<input type="checkbox" id="export-modal" class="modal-toggle" />
<div class="modal" x-data="exportModal()" x-cloak>
    <div class="modal-box w-11/12 max-w-5xl">
        <h3 class="font-bold text-lg mb-4">Eksportuoti produktus</h3>
        
        <!-- Step indicator -->
        <ul class="steps steps-horizontal w-full mb-8">
            <li class="step" :class="{'step-primary': step >= 1}">Formato pasirinkimas</li>
            <li class="step" :class="{'step-primary': step >= 2}">Laukų konfigūracija</li>
            <li class="step" :class="{'step-primary': step >= 3}">Peržiūra</li>
        </ul>
        
        <!-- Step 1: Format Selection -->
        <div x-show="step === 1" class="space-y-6">
            <div class="form-control">
                <label class="label font-semibold">
                    <span class="label-text text-lg">Pasirinkite eksporto formatą</span>
                </label>
                <div class="flex flex-col gap-4">
                    <label class="label cursor-pointer justify-start border border-base-300 rounded-lg p-4 hover:bg-base-200">
                        <input type="radio" name="format" value="csv" class="radio radio-primary mr-4" x-model="format" checked />
                        <div>
                            <div class="font-semibold">CSV</div>
                            <div class="text-sm opacity-60">Universalus formatas, palaikomas daugelio programų</div>
                        </div>
                    </label>
                    
                    <label class="label cursor-pointer justify-start border border-base-300 rounded-lg p-4 hover:bg-base-200">
                        <input type="radio" name="format" value="xlsx" class="radio radio-primary mr-4" x-model="format" />
                        <div>
                            <div class="font-semibold">Excel (XLSX)</div>
                            <div class="text-sm opacity-60">Microsoft Excel formatas</div>
                        </div>
                    </label>
                    
                    <label class="label cursor-pointer justify-start border border-base-300 rounded-lg p-4 hover:bg-base-200">
                        <input type="radio" name="format" value="xml" class="radio radio-primary mr-4" x-model="format" />
                        <div>
                            <div class="font-semibold">XML</div>
                            <div class="text-sm opacity-60">Struktūrizuotas duomenų formatas</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- XML options (only shown when XML is selected) -->
            <div x-show="format === 'xml'" class="form-control bg-base-200 p-4 rounded-lg border border-base-300">
                <label class="label font-semibold">
                    <span class="label-text">XML formato šablonas</span>
                </label>
                <select x-model="xmlTemplate" class="select select-bordered w-full">
                    <option value="generic">Bendras XML</option>
                    <option value="google_merchant">Google Merchant</option>
                </select>
                
                <div x-show="xmlTemplate === 'google_merchant'" class="alert alert-info mt-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div>
                        <p class="font-semibold">Google Merchant reikalavimai</p>
                        <p class="text-sm">Privalomi laukai: id (sku), title (name), description, link, image_link, price, availability</p>
                    </div>
                </div>
            </div>
            
            <div class="modal-action">
                <button class="btn btn-primary" @click="goToFieldMapping()">Tęsti</button>
                <label for="export-modal" class="btn" @click="resetModal()">Atšaukti</label>
            </div>
        </div>
        
        <!-- Step 2: Field Mapping -->
        <div x-show="step === 2" class="space-y-6">
            <div class="form-control">
                <label class="label font-semibold">
                    <span class="label-text text-lg">Laukų susiejimas</span>
                </label>
                <div class="overflow-x-auto">
                    <table class="table table-compact w-full">
                        <thead>
                            <tr>
                                <th>Vidinis laukas</th>
                                <th>Eksporto pavadinimas</th>
                                <th>Aprašymas</th>
                                <th>Įtraukti</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(field, index) in fields" :key="index">
                                <tr>
                                    <td x-text="field.internalName"></td>
                                    <td>
                                        <input type="text" class="input input-bordered input-sm w-full" x-model="field.exportName" :disabled="!field.included" />
                                    </td>
                                    <td class="text-sm opacity-70" x-text="field.description"></td>
                                    <td>
                                        <input type="checkbox" class="checkbox checkbox-sm" x-model="field.included" @change="updateColumnMap()" />
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Save as template -->
            <div class="form-control bg-base-200 p-4 rounded-lg">
                <label class="label cursor-pointer justify-start">
                    <input type="checkbox" class="checkbox mr-3" x-model="saveAsTemplate" />
                    <span class="label-text font-semibold">Išsaugoti kaip šabloną</span>
                </label>
                <div x-show="saveAsTemplate" class="mt-2">
                    <input type="text" class="input input-bordered w-full" placeholder="Šablono pavadinimas" x-model="templateName" />
                </div>
            </div>
            
            <div class="modal-action">
                <button class="btn" @click="step = 1">Atgal</button>
                <button class="btn btn-primary" @click="generatePreview()" :disabled="!isColumnMapValid">Peržiūrėti</button>
                <label for="export-modal" class="btn" @click="resetModal()">Atšaukti</label>
            </div>
        </div>
        
        <!-- Step 3: Preview -->
        <div x-show="step === 3" class="space-y-6">
            <div class="form-control">
                <label class="label font-semibold">
                    <span class="label-text text-lg">Peržiūra (pirmi 20 įrašų)</span>
                </label>
                
                <div x-show="loading" class="flex justify-center my-8">
                    <span class="loading loading-spinner loading-lg text-primary"></span>
                </div>
                
                <div x-show="previewError" class="alert alert-error" x-text="previewError"></div>
                
                <div x-show="!loading && !previewError && previewData.length === 0" class="alert alert-warning">
                    Nėra duomenų peržiūrai
                </div>
                
                <div x-show="!loading && previewData.length > 0" class="overflow-x-auto max-h-96">
                    <table class="table table-compact w-full">
                        <thead>
                            <tr>
                                <template x-for="(column, index) in Object.keys(previewData[0] || {})" :key="index">
                                    <th x-text="column"></th>
                                </template>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(row, rowIndex) in previewData" :key="rowIndex">
                                <tr>
                                    <template x-for="(column, colIndex) in Object.keys(previewData[0] || {})" :key="colIndex">
                                        <td x-text="row[column] || '-'"></td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="modal-action">
                <button class="btn" @click="step = 2">Atgal</button>
                <button 
                    class="btn btn-primary" 
                    @click="downloadExport()" 
                    :disabled="loading || previewData.length === 0"
                    hx-indicator="#download-indicator">
                    <span id="download-indicator" class="htmx-indicator">
                        <span class="loading loading-spinner loading-sm"></span>
                    </span>
                    Atsisiųsti
                </button>
                <label for="export-modal" class="btn" @click="resetModal()">Uždaryti</label>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/htmx.org@1.9.2"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Column preferences handler
        const saveColumnsBtn = document.getElementById('save-columns');
        if (saveColumnsBtn) {
            saveColumnsBtn.addEventListener('click', function() {
                // Show loading indicator on the button
                const originalBtnText = saveColumnsBtn.innerHTML;
                saveColumnsBtn.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Saugoma...';
                saveColumnsBtn.disabled = true;
                
                // Get all checked columns
                const checkboxes = document.querySelectorAll('#column-selector input[type="checkbox"]');
                const selectedColumns = [];
                
                // Always include required columns (sku, name)
                if (!Array.from(checkboxes).some(cb => cb.getAttribute('data-column-id') === 'sku' && cb.checked)) {
                    selectedColumns.push('sku');
                }
                
                if (!Array.from(checkboxes).some(cb => cb.getAttribute('data-column-id') === 'name' && cb.checked)) {
                    selectedColumns.push('name');
                }
                
                // Add all checked columns
                checkboxes.forEach(checkbox => {
                    const columnId = checkbox.getAttribute('data-column-id');
                    if (checkbox.checked) {
                        selectedColumns.push(columnId);
                    }
                });
                
                console.log('Saving columns:', selectedColumns);
                
                // Save preferences via API
                fetch('/api/product-columns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': getCsrfToken()
                    },
                    body: JSON.stringify({
                        columns: selectedColumns
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Server response:', data);
                    
                    if (data.success) {
                        // Show success message
                        showToast(data.message || 'Stulpelių nustatymai išsaugoti!', 'success');
                        
                        // If there's a warning about columns that couldn't be saved, show it
                        if (data.warning) {
                            setTimeout(() => {
                                showToast(data.warning, 'warning');
                            }, 500);
                        }
                        
                        // Restore button state
                        saveColumnsBtn.innerHTML = originalBtnText;
                        saveColumnsBtn.disabled = false;
                        
                        // Reload page to apply changes after a short delay
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        // Show error message
                        showToast('Klaida išsaugant nustatymus: ' + (data.error || 'Nežinoma klaida'), 'error');
                        
                        // Restore button state
                        saveColumnsBtn.innerHTML = originalBtnText;
                        saveColumnsBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error saving column preferences:', error);
                    showToast('Klaida išsaugant nustatymus: ' + error.message, 'error');
                    
                    // Restore button state
                    saveColumnsBtn.innerHTML = originalBtnText;
                    saveColumnsBtn.disabled = false;
                });
            });
        }
        
        // Helper function to get CSRF token
        function getCsrfToken() {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            return metaTag ? metaTag.getAttribute('content') || '' : '';
        }
        
        // Toast notification helper
        function showToast(message, type = 'info') {
            // Check if the toast container exists, create if not
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast toast-top toast-end z-50';
                document.body.appendChild(toastContainer);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            
            // Set alert class based on type
            let alertClass = 'alert-info';
            if (type === 'success') alertClass = 'alert-success';
            else if (type === 'error') alertClass = 'alert-error';
            else if (type === 'warning') alertClass = 'alert-warning';
            
            toast.className = `alert ${alertClass}`;
            
            // Set toast content
            toast.innerHTML = `
                <span>${message}</span>
            `;
            
            // Add to container
            toastContainer.appendChild(toast);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            }, 5000);  // Show warnings and errors longer
        }
        
        // If needed, you could add custom JavaScript here
        // Check if Alpine.js is loaded
        if (typeof Alpine === 'undefined') {
            console.error('Alpine.js is not loaded properly');
            // Attempt to load Alpine.js if it's not loaded
            const alpineScript = document.createElement('script');
            alpineScript.src = 'https://unpkg.com/alpinejs@3.13.0/dist/cdn.min.js';
            alpineScript.defer = true;
            document.body.appendChild(alpineScript);
        }
        
        // Add event listener for the export-modal checkbox to reset state when modal is closed
        document.getElementById('export-modal').addEventListener('change', function(e) {
            if (!e.target.checked) {
                // When the modal is closed (checkbox unchecked), find the Alpine component and reset it
                const modalElement = document.querySelector('[x-data="exportModal()"]');
                if (modalElement && modalElement.__x) {
                    modalElement.__x.$data.resetModal();
                }
            }
        });
    });
    
    function exportModal() {
        return {
            step: 1,
            format: 'csv',
            xmlTemplate: 'generic',
            saveAsTemplate: false,
            templateName: '',
            loading: false,
            previewData: [],
            previewError: null,
            jwtToken: null,
            
            // Initialize component and get JWT token
            init() {
                this.getJwtToken();
            },
            
            // Get JWT token for API calls
            async getJwtToken() {
                try {
                    const response = await fetch('/auth/api-token');
                    if (!response.ok) {
                        throw new Error('Failed to get API token');
                    }
                    const data = await response.json();
                    this.jwtToken = data.access_token;
                    console.log('JWT token obtained successfully');
                } catch (error) {
                    console.error('Error getting JWT token:', error);
                    this.previewError = 'Autentifikacijos klaida. Bandykite atnaujinti puslapį.';
                }
            },
            
            // Helper function to safely get CSRF token
            getCsrfToken() {
                const metaTag = document.querySelector('meta[name="csrf-token"]');
                return metaTag ? metaTag.getAttribute('content') || '' : '';
            },
            
            showToast(message, type = 'info') {
                // Check if the toast container exists, create if not
                let toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    toastContainer.className = 'toast toast-top toast-end z-50';
                    document.body.appendChild(toastContainer);
                }
                
                // Create toast element
                const toast = document.createElement('div');
                
                // Set alert class based on type
                let alertClass = 'alert-info';
                if (type === 'success') alertClass = 'alert-success';
                else if (type === 'error') alertClass = 'alert-error';
                else if (type === 'warning') alertClass = 'alert-warning';
                
                toast.className = `alert ${alertClass}`;
                
                // Set toast content
                toast.innerHTML = `
                    <span>${message}</span>
                `;
                
                // Add to container
                toastContainer.appendChild(toast);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                    setTimeout(() => {
                        toastContainer.removeChild(toast);
                    }, 300);
                }, 5000);  // Show warnings and errors longer
            },
            
            fields: [
                { internalName: 'id', exportName: 'id', description: 'Unikalus ID', included: true },
                { internalName: 'sku', exportName: 'sku', description: 'Produkto kodas', included: true },
                { internalName: 'name', exportName: 'name', description: 'Produkto pavadinimas', included: true },
                { internalName: 'description_html', exportName: 'description', description: 'Produkto aprašymas', included: true },
                { internalName: 'barcode', exportName: 'barcode', description: 'Produkto brūkšninis kodas', included: true },
                { internalName: 'quantity', exportName: 'quantity', description: 'Kiekis sandėlyje', included: true },
                { internalName: 'delivery_days', exportName: 'delivery_days', description: 'Pristatymo laikas dienomis', included: false },
                { internalName: 'price_final', exportName: 'price', description: 'Galutinė kaina', included: true },
                { internalName: 'price_old', exportName: 'price_old', description: 'Sena kaina', included: false },
                { internalName: 'category', exportName: 'category', description: 'Kategorija', included: true },
                { internalName: 'main_image_url', exportName: 'image_link', description: 'Pagrindinė nuotrauka', included: true },
                { internalName: 'model', exportName: 'model', description: 'Produkto modelis', included: false },
                { internalName: 'manufacturer', exportName: 'brand', description: 'Gamintojas', included: true },
                { internalName: 'warranty_months', exportName: 'warranty_months', description: 'Garantija mėnesiais', included: false },
                { internalName: 'weight_kg', exportName: 'weight', description: 'Svoris (kg)', included: false },
                { internalName: 'is_in_stock', exportName: 'in_stock', description: 'Ar yra sandėlyje', included: false }
            ],
            
            get columnMap() {
                const map = {};
                this.fields.filter(f => f.included).forEach(field => {
                    map[field.internalName] = field.exportName;
                });
                return map;
            },
            
            get isColumnMapValid() {
                return Object.keys(this.columnMap).length > 0;
            },
            
            updateColumnMap() {
                // Automatically update field mappings for Google Merchant if selected
                if (this.format === 'xml' && this.xmlTemplate === 'google_merchant') {
                    // Set required Google Merchant fields
                    this.fields.forEach(field => {
                        if (field.internalName === 'sku') {
                            field.exportName = 'id';
                            field.included = true;
                        } else if (field.internalName === 'name') {
                            field.exportName = 'title';
                            field.included = true;
                        } else if (field.internalName === 'description_html') {
                            field.exportName = 'description';
                            field.included = true;
                        } else if (field.internalName === 'main_image_url') {
                            field.exportName = 'image_link';
                            field.included = true;
                        } else if (field.internalName === 'price_final') {
                            field.exportName = 'price';
                            field.included = true;
                        } else if (field.internalName === 'manufacturer') {
                            field.exportName = 'brand';
                            field.included = true;
                        } else if (field.internalName === 'barcode') {
                            field.exportName = 'gtin';
                            field.included = true;
                        } else if (field.internalName === 'is_in_stock') {
                            field.exportName = 'availability';
                            field.included = true;
                        }
                    });
                }
            },
            
            goToFieldMapping() {
                this.updateColumnMap();
                this.step = 2;
            },
            
            async generatePreview() {
                this.loading = true;
                this.previewError = null;
                this.previewData = [];
                
                console.log("Starting preview generation");
                console.log("Column map:", this.columnMap);
                
                // Make sure we have a JWT token
                if (!this.jwtToken) {
                    console.log("No JWT token available, trying to get one");
                    await this.getJwtToken();
                    
                    if (!this.jwtToken) {
                        this.previewError = "Autentifikacijos klaida. Bandykite atnaujinti puslapį.";
                        this.loading = false;
                        return;
                    }
                }
                
                try {
                    const response = await fetch('/api/v1/exports/preview', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': this.getCsrfToken(),
                            'Authorization': `Bearer ${this.jwtToken}`
                        },
                        body: JSON.stringify({
                            format: this.format,
                            column_map: this.columnMap,
                            limit: 20
                        })
                    });
                    
                    console.log("API response status:", response.status);
                    
                    const result = await response.json();
                    console.log("API response data:", result);
                    
                    if (!response.ok) {
                        throw new Error(result.message || 'Klaida generuojant peržiūrą');
                    }
                    
                    this.previewData = result.data || [];
                    this.step = 3;
                } catch (error) {
                    console.error('Preview error details:', error);
                    this.previewError = error.message || 'Nepavyko gauti peržiūros duomenų';
                } finally {
                    this.loading = false;
                }
            },
            
            async downloadExport() {
                // Make sure we have a JWT token
                if (!this.jwtToken) {
                    console.log("No JWT token available for download, trying to get one");
                    await this.getJwtToken();
                    
                    if (!this.jwtToken) {
                        this.showToast("Autentifikacijos klaida. Bandykite atnaujinti puslapį.", "error");
                        return;
                    }
                }
                
                // Save template if needed
                if (this.saveAsTemplate && this.templateName) {
                    try {
                        const saveResponse = await fetch('/api/v1/exports/configs', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': this.getCsrfToken(),
                                'Authorization': `Bearer ${this.jwtToken}`
                            },
                            body: JSON.stringify({
                                name: this.templateName,
                                format: this.format,
                                column_map: this.columnMap
                            })
                        });
                        
                        if (!saveResponse.ok) {
                            const error = await saveResponse.json();
                            console.error('Error saving template:', error);
                            // Show toast notification for error
                            this.showToast('Klaida išsaugant šabloną: ' + (error.message || 'Nežinoma klaida'), 'error');
                        } else {
                            // Show success toast
                            this.showToast('Šablonas sėkmingai išsaugotas!', 'success');
                        }
                    } catch (error) {
                        console.error('Error saving template:', error);
                        this.showToast('Klaida išsaugant šabloną: ' + error.message, 'error');
                    }
                }
                
                // Prepare download params
                const downloadParams = {
                    format: this.format,
                    column_map: this.columnMap
                };
                
                // Add XML specific params if needed
                if (this.format === 'xml') {
                    if (this.xmlTemplate === 'google_merchant') {
                        downloadParams.template = 'google_merchant';
                    } else {
                        downloadParams.xml_root = 'items';
                        downloadParams.xml_item = 'item';
                    }
                }
                
                // Create a form to submit as a regular form post (for file download)
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/api/v1/exports/download';
                form.style.display = 'none';
                
                // Add JWT token
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = 'jwt_token';
                tokenInput.value = this.jwtToken;
                form.appendChild(tokenInput);
                
                // Add CSRF token
                const csrfToken = this.getCsrfToken();
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf_token';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                // Add serialized params as JSON
                const paramsInput = document.createElement('input');
                paramsInput.type = 'hidden';
                paramsInput.name = 'params';
                paramsInput.value = JSON.stringify(downloadParams);
                form.appendChild(paramsInput);
                
                // Submit the form
                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);
                
                this.showToast('Eksportas pradėtas!', 'success');
            },
            
            resetModal() {
                this.step = 1;
                this.previewData = [];
                this.previewError = null;
                this.saveAsTemplate = false;
                this.templateName = '';
            }
        };
    }
</script>
{% endblock %} 
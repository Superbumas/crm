{% extends "base.html" %}

{% block title %}WordPress Integration{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex items-center mb-8">
        <h1 class="text-2xl font-bold">WordPress/WooCommerce Integration</h1>
        {% if status and status.connected %}
        <div class="ml-4 badge badge-success gap-2">
            <span class="i-heroicons-check-circle"></span>
            Connected
        </div>
        {% else %}
        <div class="ml-4 badge badge-warning gap-2">
            <span class="i-heroicons-exclamation-circle"></span>
            Not Configured
        </div>
        {% endif %}
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Configuration -->
        <div class="card bg-base-100 shadow-xl col-span-1">
            <div class="card-body">
                <h2 class="card-title">Configuration</h2>
                <form id="wordpress-config-form" class="mt-4">
                    <div class="form-control w-full">
                        <label class="label">
                            <span class="label-text">WordPress Site URL</span>
                        </label>
                        <input type="url" name="api_url" class="input input-bordered w-full" 
                               placeholder="https://yourdomain.com" 
                               value="{{ config.api_url if config else '' }}" required />
                        <label class="label">
                            <span class="label-text-alt">Your WordPress site URL</span>
                        </label>
                    </div>

                    <div class="form-control w-full mt-2">
                        <label class="label">
                            <span class="label-text">WooCommerce Consumer Key</span>
                        </label>
                        <input type="text" name="consumer_key" class="input input-bordered w-full" 
                               placeholder="ck_..." 
                               value="{{ config.consumer_key if config else '' }}" required />
                        <label class="label">
                            <span class="label-text-alt">WooCommerce REST API key</span>
                        </label>
                    </div>

                    <div class="form-control w-full mt-2">
                        <label class="label">
                            <span class="label-text">WooCommerce Consumer Secret</span>
                        </label>
                        <input type="password" name="consumer_secret" class="input input-bordered w-full" 
                               placeholder="cs_..." 
                               value="{{ config.consumer_secret if config else '' }}" required />
                        <label class="label">
                            <span class="label-text-alt">WooCommerce REST API secret</span>
                        </label>
                    </div>

                    <div class="form-control mt-6">
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                    </div>
                </form>
                <div class="mt-4 collapse collapse-arrow">
                    <input type="checkbox" /> 
                    <div class="collapse-title text-sm font-medium">
                        How to generate API credentials
                    </div>
                    <div class="collapse-content text-sm"> 
                        <ol class="list-decimal pl-4 space-y-2">
                            <li>Go to your WordPress admin panel</li>
                            <li>Navigate to WooCommerce > Settings > Advanced > REST API</li>
                            <li>Click "Add key"</li>
                            <li>Enter a description (e.g. "VakaSport CRM")</li>
                            <li>Set user to an admin account</li>
                            <li>Set permissions to "Read/Write"</li>
                            <li>Click "Generate API key"</li>
                            <li>Copy the Consumer Key and Consumer Secret</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sync Controls -->
        <div class="card bg-base-100 shadow-xl col-span-1 lg:col-span-2">
            <div class="card-body">
                <h2 class="card-title mb-4">Sync Controls</h2>
                
                {% if status and status.connected %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h3 class="card-title text-lg">Products</h3>
                            <p class="text-sm">Push products from CRM to WooCommerce</p>
                            <div class="card-actions mt-4">
                                <button id="btn-push-all-products" class="btn btn-primary">
                                    <span class="i-heroicons-arrow-up-tray mr-2"></span>
                                    Push All Products
                                </button>
                                <button id="btn-push-selected-products" class="btn btn-outline">
                                    Push Selected
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h3 class="card-title text-lg">Orders</h3>
                            <p class="text-sm">Pull orders from WooCommerce to CRM</p>
                            <div class="card-actions mt-4">
                                <button id="btn-pull-orders" class="btn btn-primary">
                                    <span class="i-heroicons-arrow-down-tray mr-2"></span>
                                    Pull Orders
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h3 class="card-title text-lg">Stock Levels</h3>
                            <p class="text-sm">Update WooCommerce stock from CRM</p>
                            <div class="card-actions mt-4">
                                <button id="btn-sync-stock" class="btn btn-primary">
                                    <span class="i-heroicons-arrows-right-left mr-2"></span>
                                    Sync Stock Levels
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-base-200">
                        <div class="card-body">
                            <h3 class="card-title text-lg">Statistics</h3>
                            <p class="text-sm">Get sales statistics from WooCommerce</p>
                            <div class="card-actions mt-4">
                                <button id="btn-get-stats" class="btn btn-primary">
                                    <span class="i-heroicons-chart-bar mr-2"></span>
                                    Get Statistics
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <span class="i-heroicons-exclamation-triangle"></span>
                    <span>Please configure the WordPress integration first.</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Sync history -->
        <div class="card bg-base-100 shadow-xl col-span-1 lg:col-span-3">
            <div class="card-body">
                <h2 class="card-title mb-4">Sync History</h2>
                
                {% if sync_logs and sync_logs|length > 0 %}
                <div class="overflow-x-auto">
                    <table class="table table-zebra">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Processed</th>
                                <th>Created</th>
                                <th>Updated</th>
                                <th>Failed</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in sync_logs %}
                            <tr>
                                <td>{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ log.entity_type }}</td>
                                <td>
                                    {% if log.status.value == 'success' %}
                                    <span class="badge badge-success">Success</span>
                                    {% elif log.status.value == 'partial' %}
                                    <span class="badge badge-warning">Partial</span>
                                    {% elif log.status.value == 'in_progress' %}
                                    <span class="badge badge-info">In Progress</span>
                                    {% else %}
                                    <span class="badge badge-error">Failed</span>
                                    {% endif %}
                                </td>
                                <td>{{ log.records_processed }}</td>
                                <td>{{ log.records_created }}</td>
                                <td>{{ log.records_updated }}</td>
                                <td>{{ log.records_failed }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <span class="i-heroicons-information-circle"></span>
                    <span>No sync history available.</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Sync status modal -->
<dialog id="sync-status-modal" class="modal">
    <form method="dialog" class="modal-box">
        <h3 class="font-bold text-lg" id="sync-status-title">Sync in Progress</h3>
        <div class="py-4">
            <div id="sync-progress" class="flex flex-col items-center">
                <div class="loading loading-spinner loading-lg"></div>
                <p id="sync-message" class="mt-4">Processing...</p>
            </div>
            <div id="sync-results" class="mt-4 hidden">
                <div class="stats stats-vertical lg:stats-horizontal shadow w-full">
                    <div class="stat">
                        <div class="stat-title">Total</div>
                        <div class="stat-value" id="sync-total">0</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-title">Success</div>
                        <div class="stat-value text-success" id="sync-success">0</div>
                    </div>
                    
                    <div class="stat">
                        <div class="stat-title">Failed</div>
                        <div class="stat-value text-error" id="sync-failed">0</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-action">
            <button class="btn">Close</button>
        </div>
    </form>
</dialog>

<!-- Sales Stats Modal -->
<dialog id="sales-stats-modal" class="modal">
    <form method="dialog" class="modal-box max-w-3xl">
        <h3 class="font-bold text-lg mb-4">WooCommerce Sales Statistics</h3>
        <div id="sales-stats-loading" class="flex justify-center items-center p-8">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
        <div id="sales-stats-content" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="stat bg-base-200 rounded-lg">
                    <div class="stat-title">Total Sales</div>
                    <div id="stats-total-sales" class="stat-value">€0.00</div>
                </div>
                <div class="stat bg-base-200 rounded-lg">
                    <div class="stat-title">Orders</div>
                    <div id="stats-total-orders" class="stat-value">0</div>
                </div>
                <div class="stat bg-base-200 rounded-lg">
                    <div class="stat-title">Avg. Order Value</div>
                    <div id="stats-avg-order" class="stat-value">€0.00</div>
                </div>
            </div>
            <div class="w-full h-64">
                <canvas id="sales-chart"></canvas>
            </div>
        </div>
        <div class="modal-action">
            <button class="btn">Close</button>
        </div>
    </form>
</dialog>

<!-- Categories Modal -->
<dialog id="categories-modal" class="modal">
    <form method="dialog" class="modal-box max-w-4xl">
        <h3 class="font-bold text-lg mb-4">WooCommerce Product Categories</h3>
        
        <div id="categories-loading" class="flex justify-center items-center p-8">
            <span class="loading loading-spinner loading-lg"></span>
        </div>
        
        <div id="categories-content" class="hidden">
            <div class="flex justify-between mb-4">
                <h4 class="text-md font-semibold">Categories</h4>
                <button id="btn-add-category" class="btn btn-sm btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Add Category
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Slug</th>
                            <th>Parent</th>
                            <th>Count</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="categories-table-body">
                        <!-- Categories will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="modal-action">
            <button class="btn">Close</button>
        </div>
    </form>
</dialog>

<!-- Category Edit Modal -->
<dialog id="category-edit-modal" class="modal">
    <form id="category-form" method="dialog" class="modal-box">
        <h3 id="category-form-title" class="font-bold text-lg mb-4">Add Category</h3>
        
        <input type="hidden" id="category-id" value="">
        
        <div class="form-control mb-4">
            <label class="label" for="category-name">
                <span class="label-text">Name*</span>
            </label>
            <input id="category-name" type="text" class="input input-bordered" required>
        </div>
        
        <div class="form-control mb-4">
            <label class="label" for="category-slug">
                <span class="label-text">Slug</span>
            </label>
            <input id="category-slug" type="text" class="input input-bordered" placeholder="auto-generated-if-empty">
        </div>
        
        <div class="form-control mb-4">
            <label class="label" for="category-parent">
                <span class="label-text">Parent Category</span>
            </label>
            <select id="category-parent" class="select select-bordered">
                <option value="0">None (Top Level)</option>
                <!-- Parent categories will be loaded here -->
            </select>
        </div>
        
        <div class="form-control mb-4">
            <label class="label" for="category-description">
                <span class="label-text">Description</span>
            </label>
            <textarea id="category-description" class="textarea textarea-bordered" rows="3"></textarea>
        </div>
        
        <div class="modal-action">
            <button type="button" class="btn btn-ghost" onclick="document.getElementById('category-edit-modal').close()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
        </div>
    </form>
</dialog>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get or refresh JWT token
    function getJwtToken() {
        // Try to get from localStorage first
        let token = localStorage.getItem('jwt_token');
        
        // If no token in localStorage, check if it's in a cookie or get a new one
        if (!token) {
            // You may need to implement a function to get a new token
            console.warn('No JWT token found - user may need to login again');
            showToast('warning', 'Authentication token missing. You may need to log in again.');
        }
        
        return token;
    }

    // Configuration form
    const configForm = document.getElementById('wordpress-config-form');
    configForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(configForm);
        const data = {
            api_url: formData.get('api_url'),
            consumer_key: formData.get('consumer_key'),
            consumer_secret: formData.get('consumer_secret')
        };
        
        const token = getJwtToken();
        if (!token) {
            showToast('error', 'Authentication token missing. Please log in again.');
            return;
        }
        
        fetch('/api/v1/wordpress/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': '{{ csrf_token() }}',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 401) {
                    // Token expired or invalid
                    localStorage.removeItem('jwt_token');
                    showToast('error', 'Your session has expired. Please log in again.');
                    setTimeout(() => {
                        window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
                    }, 2000);
                    throw new Error('Authentication failed');
                }
                return response.json().then(data => {
                    throw new Error(data.message || 'Failed to save configuration');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.message) {
                showToast('success', data.message);
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        })
        .catch(error => {
            showToast('error', error.message || 'Failed to save configuration');
            console.error('Error:', error);
        });
    });
    
    // Push all products
    const btnPushAllProducts = document.getElementById('btn-push-all-products');
    if (btnPushAllProducts) {
        btnPushAllProducts.addEventListener('click', function() {
            const token = getJwtToken();
            if (!token) {
                showToast('error', 'Authentication token missing. Please log in again.');
                return;
            }
            
            const syncModal = document.getElementById('sync-status-modal');
            const syncTitle = document.getElementById('sync-status-title');
            const syncMessage = document.getElementById('sync-message');
            const syncProgress = document.getElementById('sync-progress');
            const syncResults = document.getElementById('sync-results');
            
            syncTitle.textContent = 'Syncing Products to WordPress';
            syncMessage.textContent = 'Pushing products to WooCommerce...';
            syncProgress.classList.remove('hidden');
            syncResults.classList.add('hidden');
            
            syncModal.showModal();
            
            fetch('/api/v1/wordpress/push/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': '{{ csrf_token() }}',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ push_all: true })
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('jwt_token');
                        syncProgress.classList.add('hidden');
                        syncMessage.textContent = 'Your session has expired. Please log in again.';
                        setTimeout(() => {
                            window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
                        }, 2000);
                        throw new Error('Authentication failed');
                    }
                    return response.json().then(data => {
                        throw new Error(data.message || 'Failed to sync products');
                    });
                }
                return response.json();
            })
            .then(data => {
                syncProgress.classList.add('hidden');
                syncResults.classList.remove('hidden');
                
                document.getElementById('sync-total').textContent = data.summary.total;
                document.getElementById('sync-success').textContent = data.summary.success;
                document.getElementById('sync-failed').textContent = data.summary.failed;
                
                syncMessage.textContent = data.message;
            })
            .catch(error => {
                syncProgress.classList.add('hidden');
                syncMessage.textContent = 'Failed to sync products: ' + (error.message || 'Unknown error');
                console.error('Error:', error);
            });
        });
    }
    
    // Pull orders
    const btnPullOrders = document.getElementById('btn-pull-orders');
    if (btnPullOrders) {
        btnPullOrders.addEventListener('click', function() {
            const token = getJwtToken();
            if (!token) {
                showToast('error', 'Authentication token missing. Please log in again.');
                return;
            }
            
            const syncModal = document.getElementById('sync-status-modal');
            const syncTitle = document.getElementById('sync-status-title');
            const syncMessage = document.getElementById('sync-message');
            const syncProgress = document.getElementById('sync-progress');
            const syncResults = document.getElementById('sync-results');
            
            syncTitle.textContent = 'Syncing Orders from WordPress';
            syncMessage.textContent = 'Pulling orders from WooCommerce...';
            syncProgress.classList.remove('hidden');
            syncResults.classList.add('hidden');
            
            syncModal.showModal();
            
            fetch('/api/v1/wordpress/pull/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': '{{ csrf_token() }}',
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('jwt_token');
                        syncProgress.classList.add('hidden');
                        syncMessage.textContent = 'Your session has expired. Please log in again.';
                        setTimeout(() => {
                            window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
                        }, 2000);
                        throw new Error('Authentication failed');
                    }
                    return response.json().then(data => {
                        throw new Error(data.message || 'Failed to sync orders');
                    });
                }
                return response.json();
            })
            .then(data => {
                syncProgress.classList.add('hidden');
                syncResults.classList.remove('hidden');
                
                document.getElementById('sync-total').textContent = data.summary.total;
                document.getElementById('sync-success').textContent = data.summary.new + data.summary.updated;
                document.getElementById('sync-failed').textContent = data.summary.failed;
                
                syncMessage.textContent = data.message;
            })
            .catch(error => {
                syncProgress.classList.add('hidden');
                syncMessage.textContent = 'Failed to sync orders: ' + (error.message || 'Unknown error');
                console.error('Error:', error);
            });
        });
    }
    
    // Get statistics
    const btnGetStats = document.getElementById('btn-get-stats');
    if (btnGetStats) {
        btnGetStats.addEventListener('click', function() {
            const token = getJwtToken();
            if (!token) {
                showToast('error', 'Authentication token missing. Please log in again.');
                return;
            }
            
            const statsModal = document.getElementById('sales-stats-modal');
            const statsLoading = document.getElementById('sales-stats-loading');
            const statsContent = document.getElementById('sales-stats-content');
            
            statsLoading.classList.remove('hidden');
            statsContent.classList.add('hidden');
            
            statsModal.showModal();
            
            fetch('/api/v1/wordpress/pull/stats', {
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'X-CSRF-TOKEN': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('jwt_token');
                        statsLoading.classList.add('hidden');
                        showToast('error', 'Your session has expired. Please log in again.');
                        statsModal.close();
                        setTimeout(() => {
                            window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
                        }, 2000);
                        throw new Error('Authentication failed');
                    }
                    return response.json().then(data => {
                        throw new Error(data.message || 'Failed to get statistics');
                    });
                }
                return response.json();
            })
            .then(data => {
                statsLoading.classList.add('hidden');
                statsContent.classList.remove('hidden');
                
                document.getElementById('stats-total-sales').textContent = '€' + parseFloat(data.total_sales).toLocaleString('lt-LT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('stats-total-orders').textContent = data.total_orders;
                document.getElementById('stats-avg-order').textContent = '€' + parseFloat(data.average_order_value).toLocaleString('lt-LT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                // Create chart if we have chart.js loaded
                if (typeof Chart !== 'undefined' && data.data && data.data.length > 0) {
                    const ctx = document.getElementById('sales-chart').getContext('2d');
                    
                    const chartData = {
                        labels: data.data.map(item => item.date),
                        datasets: [
                            {
                                label: 'Sales (€)',
                                data: data.data.map(item => item.sales),
                                borderColor: '#36A2EB',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderWidth: 2,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Orders',
                                data: data.data.map(item => item.orders),
                                borderColor: '#FF6384',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderWidth: 2,
                                yAxisID: 'y1'
                            }
                        ]
                    };
                    
                    const config = {
                        type: 'line',
                        data: chartData,
                        options: {
                            responsive: true,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'Sales (€)'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Orders'
                                    },
                                    grid: {
                                        drawOnChartArea: false
                                    }
                                }
                            }
                        }
                    };
                    
                    new Chart(ctx, config);
                }
            })
            .catch(error => {
                statsLoading.classList.add('hidden');
                statsContent.classList.add('hidden');
                showToast('error', error.message || 'Failed to get statistics');
                console.error('Error:', error);
                statsModal.close();
            });
        });
    }

    // Category Management
    const btnManageCategories = document.getElementById('btn-manage-categories');
    if (btnManageCategories) {
        btnManageCategories.addEventListener('click', function() {
            const token = getJwtToken();
            if (!token) {
                showToast('error', 'Authentication token missing. Please log in again.');
                return;
            }
            
            const categoriesModal = document.getElementById('categories-modal');
            const categoriesLoading = document.getElementById('categories-loading');
            const categoriesContent = document.getElementById('categories-content');
            const categoriesTableBody = document.getElementById('categories-table-body');
            
            categoriesLoading.classList.remove('hidden');
            categoriesContent.classList.add('hidden');
            categoriesTableBody.innerHTML = '';
            
            categoriesModal.showModal();
            
            // Load categories
            loadCategories(token);
        });
    }
    
    // Load categories from API
    function loadCategories(token) {
        const categoriesLoading = document.getElementById('categories-loading');
        const categoriesContent = document.getElementById('categories-content');
        const categoriesTableBody = document.getElementById('categories-table-body');
        const categoryParentSelect = document.getElementById('category-parent');
        
        fetch('/api/v1/wordpress/categories', {
            headers: {
                'Authorization': 'Bearer ' + token,
                'X-CSRF-TOKEN': '{{ csrf_token() }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 401) {
                    localStorage.removeItem('jwt_token');
                    categoriesLoading.classList.add('hidden');
                    showToast('error', 'Your session has expired. Please log in again.');
                    document.getElementById('categories-modal').close();
                    setTimeout(() => {
                        window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname);
                    }, 2000);
                    throw new Error('Authentication failed');
                }
                return response.json().then(data => {
                    throw new Error(data.message || 'Failed to load categories');
                });
            }
            return response.json();
        })
        .then(data => {
            categoriesLoading.classList.add('hidden');
            categoriesContent.classList.remove('hidden');
            
            // Clear current options (except "None")
            while (categoryParentSelect.options.length > 1) {
                categoryParentSelect.remove(1);
            }
            
            // Populate table and parent dropdown
            if (data.categories && data.categories.length > 0) {
                data.categories.forEach(category => {
                    // Add to table
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${category.id}</td>
                        <td>${category.name}</td>
                        <td>${category.slug}</td>
                        <td>${category.parent ? category.parent : '-'}</td>
                        <td>${category.count}</td>
                        <td>
                            <div class="flex space-x-2">
                                <button class="btn btn-xs btn-primary edit-category" data-id="${category.id}">Edit</button>
                                <button class="btn btn-xs btn-error delete-category" data-id="${category.id}">Delete</button>
                            </div>
                        </td>
                    `;
                    categoriesTableBody.appendChild(row);
                    
                    // Add to parent select
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categoryParentSelect.appendChild(option);
                });
                
                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-category').forEach(button => {
                    button.addEventListener('click', function() {
                        const categoryId = this.getAttribute('data-id');
                        editCategory(categoryId, token);
                    });
                });
                
                document.querySelectorAll('.delete-category').forEach(button => {
                    button.addEventListener('click', function() {
                        const categoryId = this.getAttribute('data-id');
                        if (confirm('Are you sure you want to delete this category?')) {
                            deleteCategory(categoryId, token);
                        }
                    });
                });
            } else {
                categoriesTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">No categories found</td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            categoriesLoading.classList.add('hidden');
            showToast('error', error.message || 'Failed to load categories');
            console.error('Error:', error);
        });
    }
    
    // Add category button
    const btnAddCategory = document.getElementById('btn-add-category');
    if (btnAddCategory) {
        btnAddCategory.addEventListener('click', function() {
            // Reset form
            document.getElementById('category-form-title').textContent = 'Add Category';
            document.getElementById('category-id').value = '';
            document.getElementById('category-name').value = '';
            document.getElementById('category-slug').value = '';
            document.getElementById('category-parent').value = '0';
            document.getElementById('category-description').value = '';
            
            // Show modal
            document.getElementById('category-edit-modal').showModal();
        });
    }
    
    // Edit category
    function editCategory(categoryId, token) {
        fetch(`/api/v1/wordpress/categories/${categoryId}`, {
            headers: {
                'Authorization': 'Bearer ' + token,
                'X-CSRF-TOKEN': '{{ csrf_token() }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || 'Failed to get category');
                });
            }
            return response.json();
        })
        .then(category => {
            // Populate form
            document.getElementById('category-form-title').textContent = 'Edit Category';
            document.getElementById('category-id').value = category.id;
            document.getElementById('category-name').value = category.name;
            document.getElementById('category-slug').value = category.slug;
            document.getElementById('category-parent').value = category.parent || '0';
            document.getElementById('category-description').value = category.description || '';
            
            // Show modal
            document.getElementById('category-edit-modal').showModal();
        })
        .catch(error => {
            showToast('error', error.message || 'Failed to get category');
            console.error('Error:', error);
        });
    }
    
    // Delete category
    function deleteCategory(categoryId, token) {
        fetch(`/api/v1/wordpress/categories/${categoryId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Bearer ' + token,
                'X-CSRF-TOKEN': '{{ csrf_token() }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || 'Failed to delete category');
                });
            }
            return response.json();
        })
        .then(data => {
            showToast('success', data.message || 'Category deleted successfully');
            // Reload categories
            loadCategories(token);
        })
        .catch(error => {
            showToast('error', error.message || 'Failed to delete category');
            console.error('Error:', error);
        });
    }
    
    // Category form submit
    const categoryForm = document.getElementById('category-form');
    if (categoryForm) {
        categoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const token = getJwtToken();
            if (!token) {
                showToast('error', 'Authentication token missing. Please log in again.');
                return;
            }
            
            const categoryId = document.getElementById('category-id').value;
            const categoryData = {
                name: document.getElementById('category-name').value,
                slug: document.getElementById('category-slug').value || undefined,
                parent: parseInt(document.getElementById('category-parent').value) || 0,
                description: document.getElementById('category-description').value || undefined
            };
            
            let url = '/api/v1/wordpress/categories';
            let method = 'POST';
            
            if (categoryId) {
                url = `/api/v1/wordpress/categories/${categoryId}`;
                method = 'PUT';
            }
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token,
                    'X-CSRF-TOKEN': '{{ csrf_token() }}'
                },
                body: JSON.stringify(categoryData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Failed to save category');
                    });
                }
                return response.json();
            })
            .then(data => {
                showToast('success', categoryId ? 'Category updated successfully' : 'Category created successfully');
                document.getElementById('category-edit-modal').close();
                // Reload categories
                loadCategories(token);
            })
            .catch(error => {
                showToast('error', error.message || 'Failed to save category');
                console.error('Error:', error);
            });
        });
    }
});

function showToast(type, message) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} fixed bottom-4 right-4 w-auto z-50`;
    toast.innerHTML = `
        <span>${message}</span>
        <button class="btn btn-sm btn-ghost" onclick="this.parentElement.remove()">×</button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
{% endblock %} 
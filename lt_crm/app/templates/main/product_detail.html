{% extends "base.html" %}

{% block styles %}
<style>
    [x-cloak] { display: none !important; }
    
    /* Enhanced visual hierarchy */
    .product-header {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
    }
    
    .info-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }
    
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    /* Enhanced gallery styling */
    .gallery-thumbnail { 
        cursor: pointer; 
        transition: all 0.2s ease-in-out;
        border: 2px solid #e2e8f0;
    }
    .gallery-thumbnail:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        border-color: #3b82f6;
    }
    
    .main-image-container {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        overflow: hidden;
    }
    
    /* Enhanced status badges */
    .status-badge {
        font-weight: 600;
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .status-in-stock {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }
    
    .status-out-of-stock {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
    
    .status-low-stock {
        background-color: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }
    
    /* Enhanced price display */
    .price-display {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border: 1px solid #93c5fd;
        border-radius: 0.75rem;
        padding: 1.5rem;
    }
    
    .price-main {
        font-size: 2.25rem;
        font-weight: 800;
        color: #1e40af;
        line-height: 1;
    }
    
    .price-old {
        font-size: 1.125rem;
        color: #6b7280;
        text-decoration: line-through;
    }
    
    /* Enhanced quantity display */
    .quantity-display {
        padding: 1.5rem;
        border-radius: 0.75rem;
        border: 1px solid;
    }
    
    .quantity-high {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        border-color: #86efac;
        color: #166534;
    }
    
    .quantity-medium {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-color: #fcd34d;
        color: #92400e;
    }
    
    .quantity-low {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        border-color: #f87171;
        color: #991b1b;
    }
    
    /* Enhanced action buttons */
    .action-btn {
        transition: all 0.15s ease;
        border-radius: 0.5rem;
        font-weight: 600;
    }
    
    .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Enhanced table styling */
    .detail-table {
        background: white;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .detail-table th {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        font-weight: 600;
        color: #374151;
        padding: 1rem;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .detail-table td {
        padding: 0.875rem 1rem;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .detail-table tbody tr:hover {
        background-color: #f8fafc;
    }
    
    /* Enhanced lightbox */
    .lightbox-slide {
        transition: opacity 0.3s ease-in-out;
    }
    
    /* Improved responsive design */
    @media (max-width: 768px) {
        .price-main {
            font-size: 1.875rem;
        }
        
        .info-card {
            margin-bottom: 1rem;
        }
        
        .action-btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
    
    /* Accessibility improvements */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
    
    /* Focus indicators */
    .focus-visible:focus {
        outline: 2px solid #3b82f6;
        outline-offset: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <!-- Enhanced Header -->
    <div class="product-header p-6 mb-6">
        <nav class="text-sm breadcrumbs mb-4" aria-label="Breadcrumb">
            <ul>
                <li><a href="{{ url_for('main.dashboard') }}" class="text-blue-600 hover:text-blue-800">Skydelis</a></li>
                <li><a href="{{ url_for('main.products') }}" class="text-blue-600 hover:text-blue-800">Produktai</a></li>
                <li><span class="text-gray-500">{{ product.name }}</span></li>
            </ul>
        </nav>
        
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <div class="flex-1">
                <h1 class="text-4xl font-bold text-gray-900 mb-2">{{ product.name }}</h1>
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <span class="text-lg font-medium text-gray-600">SKU: {{ product.sku }}</span>
                    {% if product.quantity > 10 %}
                    <span class="status-badge status-in-stock">Yra sandėlyje</span>
                    {% elif product.quantity > 0 %}
                    <span class="status-badge status-low-stock">Mažas kiekis</span>
                    {% else %}
                    <span class="status-badge status-out-of-stock">Nėra sandėlyje</span>
                    {% endif %}
                    {% if product.category %}
                    <span class="badge badge-outline badge-lg">{{ product.category }}</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="flex flex-wrap gap-3">
                <a href="{{ url_for('main.products') }}" class="btn btn-outline action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Grįžti
                </a>
                <a href="{{ url_for('main.product_edit', id=product.id) }}" class="btn btn-primary action-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                    Redaguoti
                </a>
            </div>
        </div>
    </div>

    <!-- Enhanced Main Product Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <!-- Enhanced Product Image -->
        <div class="info-card rounded-xl overflow-hidden">
            {% if product.main_image_url %}
            <div class="main-image-container relative">
                <figure class="relative pt-[75%]">
                    <img src="{{ product.main_image_url }}" alt="{{ product.name }}" 
                         class="absolute inset-0 w-full h-full object-contain p-6 gallery-thumbnail cursor-pointer focus-visible" 
                         onclick="window.openProductGallery(0)"
                         onerror="this.style.display='none';"
                         tabindex="0"
                         role="button"
                         aria-label="Atidaryti produkto nuotraukų galeriją">
                </figure>
                <div class="absolute top-4 right-4">
                    <button class="btn btn-circle btn-sm btn-ghost bg-white/80 hover:bg-white" 
                            onclick="window.openProductGallery(0)"
                            aria-label="Padidinti nuotrauką">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </div>
            </div>
            {% else %}
            <div class="main-image-container relative">
                <figure class="relative pt-[75%] bg-gray-100">
                    <div class="absolute inset-0 flex items-center justify-center text-gray-400">
                        <div class="text-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" 
                                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="text-sm font-medium">Nuotrauka nepateikta</p>
                        </div>
                    </div>
                </figure>
            </div>
            {% endif %}
            
            {% if product.extra_image_urls %}
            <div class="p-4 border-t border-gray-200">
                <h3 class="font-semibold text-gray-900 mb-3">Papildomos nuotraukos</h3>
                <div class="grid grid-cols-4 gap-2">
                    {% set img_urls = [] %}
                    {% if product.extra_image_urls is string and '|' in product.extra_image_urls %}
                        {% set img_urls = product.extra_image_urls.split('|') %}
                    {% elif product.extra_image_urls is iterable and product.extra_image_urls is not string %}
                        {% set img_urls = product.extra_image_urls %}
                    {% endif %}
                    
                    {% for img_url in img_urls %}
                    {% set img_url_trimmed = img_url.strip() %}
                    {% if img_url_trimmed %}
                    <div class="aspect-square">
                        <img src="{{ img_url_trimmed }}" alt="{{ product.name }} - nuotrauka {{ loop.index }}" 
                             class="w-full h-full object-cover rounded-md gallery-thumbnail cursor-pointer focus-visible"
                             onclick="window.openProductGallery({{ loop.index }})"
                             onerror="this.parentElement.style.display='none';"
                             tabindex="0"
                             role="button"
                             aria-label="Atidaryti nuotrauką {{ loop.index }}">
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Enhanced Product Information -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Price and Stock Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Price Card -->
                <div class="price-display">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold text-blue-900">Kaina</h3>
                        <span class="text-2xl font-bold text-blue-600">€</span>
                    </div>
                    <div class="price-main">{{ product.price_final|euro }}</div>
                    {% if product.price_old %}
                    <div class="price-old mt-1">Buvo: {{ product.price_old|euro }}</div>
                    {% endif %}
                </div>
                
                <!-- Stock Card -->
                <div class="quantity-display {% if product.quantity > 10 %}quantity-high{% elif product.quantity > 0 %}quantity-medium{% else %}quantity-low{% endif %}">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-semibold">Sandėlio likutis</h3>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                    </div>
                    <div class="text-3xl font-bold">{{ product.quantity }} vnt.</div>
                    <div class="text-sm mt-1">
                        {% if product.quantity > 10 %}
                        Pakankamas kiekis
                        {% elif product.quantity > 0 %}
                        Mažas kiekis - reikia papildyti
                        {% else %}
                        Nėra sandėlyje
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Product Details -->
            <div class="info-card rounded-xl p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Produkto informacija</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Basic Information -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2">Pagrindinė informacija</h3>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600 font-medium">Produkto kodas</span>
                                <code class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ product.sku }}</code>
                            </div>
                            
                            {% if product.barcode %}
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600 font-medium">Brūkšninis kodas</span>
                                <code class="bg-gray-100 px-3 py-1 rounded font-mono text-sm">{{ product.barcode }}</code>
                            </div>
                            {% endif %}
                            
                            {% if product.category %}
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600 font-medium">Kategorija</span>
                                <span class="font-semibold text-gray-900">{{ product.category }}</span>
                            </div>
                            {% endif %}
                            
                            {% if product.manufacturer %}
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600 font-medium">Gamintojas</span>
                                <span class="font-semibold text-gray-900">{{ product.manufacturer }}</span>
                            </div>
                            {% endif %}
                            
                            {% if product.model %}
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600 font-medium">Modelis</span>
                                <span class="font-semibold text-gray-900">{{ product.model }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Additional Details -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-gray-800 border-b border-gray-200 pb-2">Papildoma informacija</h3>
                        
                        <div class="space-y-4">
                            {% if product.delivery_days is not none %}
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600 font-medium">Pristatymo trukmė</span>
                                <span class="font-semibold text-gray-900">{{ product.delivery_days }} d.</span>
                            </div>
                            {% endif %}
                            
                            {% if product.warranty_months is not none %}
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600 font-medium">Garantija</span>
                                <span class="font-semibold text-gray-900">{{ product.warranty_months }} mėn.</span>
                            </div>
                            {% endif %}
                            
                            {% if product.weight_kg is not none %}
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600 font-medium">Svoris</span>
                                <span class="font-semibold text-gray-900">{{ product.weight_kg }} kg</span>
                            </div>
                            {% endif %}
                            
                            <div class="flex justify-between items-center py-2 border-b border-gray-100">
                                <span class="text-gray-600 font-medium">Sukurtas</span>
                                <span class="font-semibold text-gray-900">{{ product.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            </div>
                            
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-600 font-medium">Atnaujintas</span>
                                <span class="font-semibold text-gray-900">{{ product.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Parameters Section -->
    {% if product.parameters %}
    <div class="info-card rounded-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Produkto parametrai</h2>
        <div class="overflow-x-auto">
            <table class="detail-table w-full">
                <tbody>
                    {% for key, value in product.get_parameters().items() %}
                    <tr>
                        <td class="font-semibold text-gray-700 w-1/3">{{ key }}</td>
                        <td class="text-gray-900">{{ value }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
                
    <!-- Enhanced Description Section -->
    <div class="info-card rounded-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Produkto aprašymas</h2>
        <div class="prose max-w-none bg-gray-50 p-6 rounded-lg border border-gray-200">
            {% if product.description_html %}
                {{ product.description_html|safe }}
            {% else %}
                <div class="text-center py-8">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-300 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="text-gray-500 italic">Produkto aprašymas nepateiktas</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Variants Section -->
    {% if product.variants %}
    <div class="info-card rounded-xl p-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Produkto variantai</h2>
        <div class="overflow-x-auto">
            <table class="detail-table w-full">
                <thead>
                    <tr>
                        <th scope="col" class="text-left">Kodas</th>
                        <th scope="col" class="text-left">Pavadinimas</th>
                        <th scope="col" class="text-center">Kaina</th>
                        <th scope="col" class="text-center">Likutis</th>
                    </tr>
                </thead>
                <tbody>
                    {% if product.variants is iterable and product.variants is not string %}
                        {% for variant in product.variants %}
                        <tr>
                            <td>
                                <code class="bg-gray-100 px-2 py-1 rounded text-sm">
                                    {{ variant.sku if variant is mapping and variant.sku is defined else '-' }}
                                </code>
                            </td>
                            <td class="font-medium text-gray-900">
                                {{ variant.name if variant is mapping and variant.name is defined else '-' }}
                            </td>
                            <td class="text-center font-semibold text-blue-600">
                                {{ variant.price|euro if variant is mapping and variant.price is defined else '-' }}
                            </td>
                            <td class="text-center">
                                {% if variant.quantity is defined and variant.quantity is not string %}
                                    {% if variant.quantity > 10 %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 border border-green-200">
                                        {{ variant.quantity }} vnt.
                                    </span>
                                    {% elif variant.quantity > 0 %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                                        {{ variant.quantity }} vnt.
                                    </span>
                                    {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 border border-red-200">
                                        {{ variant.quantity }} vnt.
                                    </span>
                                    {% endif %}
                                {% elif variant.quantity is defined and variant.quantity is string %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 border border-blue-200">
                                        {{ variant.quantity }}
                                    </span>
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center py-12">
                            <div class="flex flex-col items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                                </svg>
                                <p class="text-gray-500 text-lg font-medium">Nėra variantų</p>
                                <p class="text-gray-400 text-sm mt-1">Produkto variantai bus rodomi čia, jei jie bus sukurti</p>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Enhanced Stock Movement History -->
    <div class="info-card rounded-xl p-6 mt-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Atsargų judėjimo istorija</h2>
            <div class="flex items-center text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span class="text-sm">Paskutiniai 10 įrašų</span>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="detail-table w-full" role="table" aria-label="Atsargų judėjimo istorija">
                <thead>
                    <tr>
                        <th scope="col" class="text-left">Data ir laikas</th>
                        <th scope="col" class="text-center">Tipas</th>
                        <th scope="col" class="text-center">Kiekio pokytis</th>
                        <th scope="col" class="text-left">Aprašymas</th>
                        <th scope="col" class="text-center">Nuoroda</th>
                    </tr>
                </thead>
                <tbody>
                    {% if stock_movements %}
                        {% for movement in stock_movements %}
                        <tr>
                            <td>
                                <div class="font-medium text-gray-900">{{ movement.created_at.strftime('%Y-%m-%d') }}</div>
                                <div class="text-sm text-gray-500">{{ movement.created_at.strftime('%H:%M') }}</div>
                            </td>
                            <td class="text-center">
                                {% if movement.qty_delta > 0 %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 border border-green-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Papildymas
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 border border-red-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                                    </svg>
                                    Nurašymas
                                </span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <span class="font-bold text-lg {% if movement.qty_delta > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                    {% if movement.qty_delta > 0 %}+{% endif %}{{ movement.qty_delta }}
                                </span>
                                <span class="text-sm text-gray-500 ml-1">vnt.</span>
                            </td>
                            <td>
                                {% if movement.note %}
                                <span class="text-gray-900">{{ movement.note }}</span>
                                {% else %}
                                <span class="text-gray-400 italic">Aprašymas nepateiktas</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if (movement.reason_code.value is defined and movement.reason_code.value in ('sale', 'SALE')) or 
                                       (movement.reason_code is string and movement.reason_code in ('sale', 'SALE')) %}
                                <a href="{{ url_for('main.order_detail', id=movement.reference_id) }}" 
                                   class="inline-flex items-center px-3 py-1 rounded-md text-sm font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 border border-blue-200 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                                    </svg>
                                    Užsakymas #{{ movement.reference_id }}
                                </a>
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-12">
                                <div class="flex flex-col items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                    <p class="text-gray-500 text-lg font-medium">Nėra atsargų judėjimo įrašų</p>
                                    <p class="text-gray-400 text-sm mt-1">Atsargų judėjimas bus rodomas čia, kai bus atlikti sandėlio operacijos</p>
                                </div>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Image Gallery Lightbox -->
    <div id="image-gallery-modal" class="modal">
        <div class="modal-box max-w-5xl relative p-0 bg-base-200">
            <!-- Close button -->
            <button onclick="closeGallery()" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 z-50">✕</button>
            
            <!-- Image container -->
            <div class="relative h-[70vh] overflow-hidden">
                <!-- Main Image -->
                <div id="gallery-image-container" class="absolute inset-0 flex items-center justify-center p-4">
                    <img id="active-gallery-image" src="" alt="{{ product.name }}" class="max-h-full max-w-full object-contain">
                </div>
                
                <!-- Navigation arrows -->
                <button onclick="prevImage()" class="btn btn-circle btn-ghost absolute left-2 top-1/2 -translate-y-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <button onclick="nextImage()" class="btn btn-circle btn-ghost absolute right-2 top-1/2 -translate-y-1/2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
            
            <!-- Thumbnails for navigation -->
            <div class="p-4 bg-base-100">
                <div id="thumbnail-container" class="flex overflow-x-auto space-x-2 pb-2">
                    <!-- Thumbnails will be inserted here by JavaScript -->
                </div>
                <div class="flex justify-between items-center mt-2">
                    <div id="image-counter" class="text-sm"></div>
                    <div>
                        <button id="slideshow-start" onclick="startSlideshow()" class="btn btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Paleisti demonstraciją
                        </button>
                        <button id="slideshow-stop" onclick="stopSlideshow()" class="btn btn-sm hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                            </svg>
                            Sustabdyti
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // All gallery image URLs
    const allImages = [
        {% if product.main_image_url %}
        "{{ product.main_image_url }}",
        {% endif %}
        {% if product.extra_image_urls %}
            {% set img_urls = [] %}
            {% if product.extra_image_urls is string and '|' in product.extra_image_urls %}
                {% set img_urls = product.extra_image_urls.split('|') %}
            {% elif product.extra_image_urls is iterable and product.extra_image_urls is not string %}
                {% set img_urls = product.extra_image_urls %}
            {% endif %}
            
            {% for img_url in img_urls %}
            {% set img_url_trimmed = img_url.strip() %}
            {% if img_url_trimmed %}
            "{{ img_url_trimmed }}",
            {% endif %}
            {% endfor %}
        {% endif %}
    ];
    
    // Gallery state
    let currentImageIndex = 0;
    let isSlideshowRunning = false;
    let slideshowInterval = null;
    const slideshowSpeed = 3000; // milliseconds
    
    // DOM elements
    const imageGalleryModal = document.getElementById('image-gallery-modal');
    const activeGalleryImage = document.getElementById('active-gallery-image');
    const thumbnailContainer = document.getElementById('thumbnail-container');
    const imageCounter = document.getElementById('image-counter');
    const slideshowStartBtn = document.getElementById('slideshow-start');
    const slideshowStopBtn = document.getElementById('slideshow-stop');
    
    // Initialize the gallery thumbnails
    function initGalleryThumbnails() {
        thumbnailContainer.innerHTML = '';
        allImages.forEach((image, index) => {
            const thumbnail = document.createElement('div');
            thumbnail.className = `w-16 h-16 flex-shrink-0 ${currentImageIndex === index ? 'ring-2 ring-primary' : ''}`;
            
            const img = document.createElement('img');
            img.src = image;
            img.alt = `Thumbnail ${index + 1}`;
            img.className = 'w-full h-full object-cover cursor-pointer rounded-md';
            img.onclick = () => setCurrentImage(index);
            
            thumbnail.appendChild(img);
            thumbnailContainer.appendChild(thumbnail);
        });
    }
    
    // Set current image
    function setCurrentImage(index) {
        currentImageIndex = index;
        activeGalleryImage.src = allImages[index];
        imageCounter.textContent = `Image ${index + 1} of ${allImages.length}`;
        
        // Update thumbnails to show selected
        const thumbnails = thumbnailContainer.children;
        for (let i = 0; i < thumbnails.length; i++) {
            if (i === index) {
                thumbnails[i].classList.add('ring-2', 'ring-primary');
            } else {
                thumbnails[i].classList.remove('ring-2', 'ring-primary');
            }
        }
    }
    
    // Open gallery
    window.openProductGallery = function(index) {
        currentImageIndex = index;
        imageGalleryModal.classList.add('modal-open');
        setCurrentImage(index);
        initGalleryThumbnails();
        
        // Add keyboard event listeners
        document.addEventListener('keydown', handleKeyEvents);
    };
    
    // Close gallery
    window.closeGallery = function() {
        imageGalleryModal.classList.remove('modal-open');
        stopSlideshow();
        
        // Remove keyboard event listeners
        document.removeEventListener('keydown', handleKeyEvents);
    };
    
    // Handle keyboard events
    function handleKeyEvents(e) {
        if (e.key === 'ArrowLeft') {
            prevImage();
        } else if (e.key === 'ArrowRight') {
            nextImage();
        } else if (e.key === 'Escape') {
            closeGallery();
        }
    }
    
    // Navigate to previous image
    window.prevImage = function() {
        currentImageIndex = (currentImageIndex - 1 + allImages.length) % allImages.length;
        setCurrentImage(currentImageIndex);
    };
    
    // Navigate to next image
    window.nextImage = function() {
        currentImageIndex = (currentImageIndex + 1) % allImages.length;
        setCurrentImage(currentImageIndex);
    };
    
    // Start slideshow
    window.startSlideshow = function() {
        if (allImages.length <= 1) return;
        
        isSlideshowRunning = true;
        slideshowStartBtn.classList.add('hidden');
        slideshowStopBtn.classList.remove('hidden');
        
        slideshowInterval = setInterval(() => {
            nextImage();
        }, slideshowSpeed);
    };
    
    // Stop slideshow
    window.stopSlideshow = function() {
        isSlideshowRunning = false;
        slideshowStartBtn.classList.remove('hidden');
        slideshowStopBtn.classList.add('hidden');
        
        clearInterval(slideshowInterval);
    };
    
    // Click outside modal to close
    imageGalleryModal.addEventListener('click', function(e) {
        if (e.target === imageGalleryModal) {
            closeGallery();
        }
    });
</script>
{% endblock %} 